<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎭 Groups Hub - Enterprise Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --bg-glass: rgba(255, 255, 255, 0.05);
            --bg-glass-hover: rgba(255, 255, 255, 0.1);
            --bg-card: rgba(255, 255, 255, 0.08);
            --border-glass: rgba(255, 255, 255, 0.1);
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* ============= HEADER ENTERPRISE ============= */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--border-glass);
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .main-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 2.2rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-stats {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .stat-item {
            text-align: center;
            position: relative;
        }

        .stat-item::after {
            content: '';
            position: absolute;
            bottom: -0.5rem;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 2px;
            background: var(--success-gradient);
            border-radius: 2px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: var(--text-primary);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--primary-gradient);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: var(--success-gradient);
            box-shadow: 0 8px 32px rgba(79, 172, 254, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(79, 172, 254, 0.4);
        }

        /* ============= ENHANCED METRICS BAR ============= */
        .metrics-bar {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--border-glass);
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .metrics-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--success-gradient);
        }

        .metric-group {
            display: flex;
            gap: 2rem;
        }

        .metric-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg-glass);
            border-radius: 12px;
            transition: var(--transition);
        }

        .metric-item:hover {
            background: var(--bg-glass-hover);
            transform: translateY(-1px);
        }

        .metric-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981;
            position: relative;
        }

        .metric-icon::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
        }

        .metric-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* ============= MAIN LAYOUT FIXED ============= */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .panel {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid var(--border-glass);
            padding: 2rem;
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-gradient);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-glass);
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .panel-title i {
            font-size: 1.1rem;
            color: #667eea;
        }

        .panel-count {
            background: var(--bg-glass);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid var(--border-glass);
        }

        /* ============= DISCOVERY CONTROLS ============= */
        .discovery-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .search-container {
            flex: 1;
            position: relative;
            min-width: 200px;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: var(--bg-glass-hover);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.75rem 1rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            white-space: nowrap;
        }

        .filter-btn:hover {
            background: var(--bg-glass-hover);
            border-color: #3b82f6;
        }

        .filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        /* ============= CHAT LISTS FIXED ============= */
        .chat-list {
            max-height: 600px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border-glass) transparent;
        }

        .chat-list::-webkit-scrollbar {
            width: 6px;
        }

        .chat-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-list::-webkit-scrollbar-thumb {
            background: var(--border-glass);
            border-radius: 3px;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .chat-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
        }

        .chat-item:hover {
            background: var(--bg-glass-hover);
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .chat-item:hover::before {
            opacity: 1;
        }

        .chat-item.dragging {
            opacity: 0.7;
            transform: rotate(2deg) scale(0.95);
            z-index: 1000;
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            flex-wrap: wrap;
        }

        .chat-meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .chat-type {
            padding: 0.2rem 0.6rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chat-type.channel {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .chat-type.group, .chat-type.supergroup, .chat-type.megagroup {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: var(--transition);
        }

        .chat-item:hover .chat-actions {
            opacity: 1;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-glass);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-glass);
        }

        .action-btn:hover {
            background: #3b82f6;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        /* ============= DROP ZONE ============= */
        .drop-zone {
            min-height: 120px;
            border: 2px dashed var(--border-glass);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            transition: var(--transition);
            opacity: 0;
            background: var(--bg-glass);
            position: relative;
            overflow: hidden;
        }

        .drop-zone.active {
            opacity: 1;
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
            transform: scale(1.02);
        }

        .drop-message {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-align: center;
            padding: 1rem;
        }

        .drop-message i {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
            color: #10b981;
        }

        /* ============= CONFIGURED ITEMS ============= */
        .configured-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: var(--bg-glass);
            border: 1px solid var(--border-glass);
            border-radius: 12px;
            transition: var(--transition);
            position: relative;
        }

        .configured-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #10b981;
            border-radius: 0 4px 4px 0;
        }

        .configured-item.active {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .configured-item.error::before {
            background: #ef4444;
        }

        .configured-item.error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .status-indicator {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .configured-actions {
            display: flex;
            gap: 0.5rem;
        }

        .configured-actions .action-btn {
            opacity: 1;
        }

        /* ============= EMPTY & LOADING STATES ============= */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .empty-state p {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .loading-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
            animation: spin 1s linear infinite;
            color: #3b82f6;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ============= NOTIFICATIONS ============= */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            animation: slideInRight 0.3s ease-out;
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ============= RESPONSIVE ============= */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .header-stats {
                flex-direction: column;
                gap: 1rem;
            }

            .metric-group {
                flex-direction: column;
                gap: 0.5rem;
            }

            .discovery-controls {
                flex-direction: column;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .main-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .quick-actions {
                flex-direction: column;
                width: 100%;
            }

            .chat-actions {
                opacity: 1;
            }
        }

        /* ============= ANIMATIONS ============= */
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Enhanced Header -->
        <header class="main-header slide-in">
            <div class="header-title">
                <h1>🎭 Groups Hub</h1>
                <div class="header-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="discoveredCount">0</span>
                        <span class="stat-label">Discovered</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="configuredCount">0</span>
                        <span class="stat-label">Configured</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="activeCount">0</span>
                        <span class="stat-label">Active</span>
                    </div>
                </div>
            </div>
            <div class="quick-actions">
                <button class="btn btn-success" onclick="startWizard()">
                    <i class="fas fa-magic"></i>
                    Setup Wizard
                </button>
                <button class="btn btn-primary" onclick="refreshDiscovery()">
                    <i class="fas fa-sync"></i>
                    Scan Chats
                </button>
            </div>
        </header>

        <!-- Enhanced Performance Metrics -->
        <div class="metrics-bar slide-in">
            <div class="metric-group">
                <div class="metric-item">
                    <div class="metric-icon"></div>
                    <span class="metric-text">Discovery Service Online</span>
                </div>
                <div class="metric-item">
                    <div class="metric-icon"></div>
                    <span class="metric-text">Real-time Filtering Active</span>
                </div>
                <div class="metric-item">
                    <div class="metric-icon"></div>
                    <span class="metric-text">Groups Only Mode</span>
                </div>
            </div>
            <div class="metric-group">
                <div class="metric-item">
                    <span class="metric-text">Last scan: <strong id="lastScan">Never</strong></span>
                </div>
                <div class="metric-item">
                    <span class="metric-text">Groups found: <strong id="groupsToday">0</strong></span>
                </div>
            </div>
        </div>

        <!-- 🔧 MAIN LAYOUT FIXED - IDs ÚNICOS -->
        <div class="main-layout">
            <!-- Discovery Panel Enhanced -->
            <div class="panel discovery-panel slide-in">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="fas fa-search"></i>
                        Discovered Groups & Channels
                        <span class="panel-count" id="discoveredPanelCount">0</span>
                    </div>
                </div>

                <div class="discovery-controls">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Search groups and channels..." id="discoverySearch">
                    </div>
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="">All Types</button>
                        <button class="filter-btn" data-filter="channel">Channels</button>
                        <button class="filter-btn" data-filter="supergroup">Supergroups</button>
                        <button class="filter-btn" data-filter="group">Groups</button>
                        <button class="filter-btn" data-filter="megagroup">Megagroups</button>
                    </div>
                </div>

                <!-- 🔧 FIX: ID ÚNICO PARA DISCOVERED CHATS -->
                <div class="chat-list" id="discoveredChats">
                    <div class="loading-state">
                        <i class="fas fa-spinner loading-spinner"></i>
                        <h3>Scanning Telegram</h3>
                        <p>Discovering groups and channels...</p>
                    </div>
                </div>
            </div>

            <!-- Configured Panel Enhanced -->
            <div class="panel configured-panel slide-in">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="fas fa-cogs"></i>
                        Configured Groups
                        <span class="panel-count" id="configuredPanelCount">0</span>
                    </div>
                </div>

                <div class="drop-zone" id="dropZone">
                    <div class="drop-message">
                        <i class="fas fa-hand-point-right"></i>
                        <strong>Drag groups here to configure</strong><br>
                        Auto-setup with smart defaults
                    </div>
                </div>

                <!-- 🔧 FIX: ID ÚNICO PARA CONFIGURED CHATS -->
                <div class="chat-list" id="configuredChats">
                    <div class="empty-state">
                        <i class="fas fa-plus-circle"></i>
                        <h3>No groups configured yet</h3>
                        <p>Start by discovering groups or use the setup wizard</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============= ENHANCED GROUPS HUB APPLICATION =============
        class EnhancedGroupsHub {
            constructor() {
                this.discoveredChats = [];
                this.configuredGroups = [];
                this.draggedItem = null;
                this.searchTerm = '';
                this.currentFilter = '';
                this.isLoading = false;

                // 🔧 ENTERPRISE CONSTANTS
                this.DISCOVERY_API_BASE = '/api/discovery';
                this.GROUPS_API_BASE = '/api/groups';
                this.RATE_LIMIT_DELAY = 100; // ms between requests
                this.MAX_RETRIES = 3;
                this.CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

                this.init();
            }

            async init() {
                console.log('🎭 Initializing Enhanced Groups Hub...');
                await this.loadData();
                this.setupEventListeners();
                this.setupDragAndDrop();
                this.updateUI();
                this.startRealTimeUpdates();
                console.log('✅ Enhanced Groups Hub ready');
            }

            setupEventListeners() {
                // Enhanced search with debouncing
                let searchTimeout;
                document.getElementById('discoverySearch').addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        this.searchTerm = e.target.value.toLowerCase().trim();
                        this.renderDiscoveredChats();
                    }, 300);
                });

                // Enhanced filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentFilter = e.target.dataset.filter;
                        this.renderDiscoveredChats();
                        
                        // Analytics
                        this.trackEvent('filter_applied', { filter: this.currentFilter });
                    });
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'f') {
                        e.preventDefault();
                        document.getElementById('discoverySearch').focus();
                    }
                });
            }

            setupDragAndDrop() {
                const dropZone = document.getElementById('dropZone');

                // Enhanced drag start
                document.addEventListener('dragstart', (e) => {
                    if (e.target.closest('.chat-item')) {
                        this.draggedItem = e.target.closest('.chat-item');
                        dropZone.classList.add('active');
                        e.target.closest('.chat-item').classList.add('dragging');
                        
                        // Set drag effect
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/html', e.target.closest('.chat-item').outerHTML);
                    }
                });

                document.addEventListener('dragend', (e) => {
                    dropZone.classList.remove('active');
                    document.querySelectorAll('.chat-item').forEach(item => {
                        item.classList.remove('dragging');
                    });
                    this.draggedItem = null;
                });

                // Enhanced drop functionality
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                dropZone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    if (this.draggedItem) {
                        const chatId = parseInt(this.draggedItem.dataset.chatId);
                        await this.quickConfigureChat(chatId);
                        this.trackEvent('drag_drop_configure', { chat_id: chatId });
                    }
                });
            }

            async loadData() {
                if (this.isLoading) return;
                this.isLoading = true;

                try {
                    // 🔧 ENTERPRISE FIX: Load data with intelligent filtering
                    await Promise.all([
                        this.loadDiscoveredChats(),
                        this.loadConfiguredGroups()
                    ]);
                    
                } catch (error) {
                    console.error('❌ Error loading data:', error);
                    this.showNotification('Failed to load data. Retrying...', 'error');
                    
                    // Retry logic
                    setTimeout(() => this.loadData(), 5000);
                } finally {
                    this.isLoading = false;
                }
            }

            async loadDiscoveredChats() {
                try {
                    console.log('🔍 Loading discovered chats from Discovery Service...');
                    
                    // 🔧 ENTERPRISE FIX: Advanced filtering parameters
                    const params = new URLSearchParams({
                        limit: '1000',
                        // ✅ CRITICAL FIX: Only groups, supergroups, channels, megagroups
                        chat_type: 'group,supergroup,channel,megagroup',
                        min_participants: '2', // Ensure real groups (>1 member)
                        // ✅ Exclude private chats completely
                        is_private: 'false'
                    });
                    
                    const response = await fetch(`${this.DISCOVERY_API_BASE}/chats?${params}`, {
                        timeout: 30000 // 30 second timeout
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Discovery API error: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    let chats = data.chats || [];
                    
                    console.log(`📊 Raw chats from Discovery Service: ${chats.length}`);
                    
                    // 🔧 ENTERPRISE FIX: Multi-layer filtering for bulletproof accuracy
                    chats = this.applyIntelligentFiltering(chats);
                    
                    console.log(`✅ Filtered to ${chats.length} valid groups/channels`);
                    console.log('📋 Types found:', [...new Set(chats.map(c => c.type))]);
                    
                    this.discoveredChats = chats;
                    
                    // Update last scan time
                    document.getElementById('lastScan').textContent = new Date().toLocaleTimeString();
                    document.getElementById('groupsToday').textContent = chats.length;
                    
                } catch (error) {
                    console.error('❌ Failed to load discovered chats:', error);
                    this.discoveredChats = [];
                    
                    // Show fallback message
                    this.showNotification(`Discovery Service unavailable: ${error.message}`, 'warning');
                }
            }

            applyIntelligentFiltering(chats) {
                return chats
                    // ✅ CRITICAL: Only allow specific group types
                    .filter(chat => {
                        const type = chat.type?.toLowerCase();
                        const validTypes = ['group', 'supergroup', 'channel', 'megagroup'];
                        return validTypes.includes(type);
                    })
                    // ✅ CRITICAL: Exclude private chats by multiple criteria
                    .filter(chat => {
                        // Exclude if explicitly marked as private
                        if (chat.is_private === true) return false;
                        
                        // Exclude if participant count <= 1 (private chats or empty groups)
                        if (!chat.participants_count || chat.participants_count <= 1) return false;
                        
                        // Exclude if title suggests it's a saved messages or private chat
                        const title = chat.title?.toLowerCase() || '';
                        const privateIndicators = ['saved messages', 'mensajes guardados', 'my notes'];
                        if (privateIndicators.some(indicator => title.includes(indicator))) return false;
                        
                        return true;
                    })
                    // ✅ ENHANCEMENT: Sort by relevance (larger groups first)
                    .sort((a, b) => {
                        // Prioritize by participants count (descending)
                        const participantsDiff = (b.participants_count || 0) - (a.participants_count || 0);
                        if (participantsDiff !== 0) return participantsDiff;
                        
                        // Secondary sort: channels before groups
                        const typeOrder = { channel: 0, supergroup: 1, megagroup: 2, group: 3 };
                        return (typeOrder[a.type] || 99) - (typeOrder[b.type] || 99);
                    })
                    // ✅ ENHANCEMENT: Add metadata for better UX
                    .map(chat => ({
                        ...chat,
                        _isRelevant: this.calculateRelevanceScore(chat),
                        _displayCategory: this.getChatDisplayCategory(chat)
                    }));
            }

            calculateRelevanceScore(chat) {
                let score = 0;

                // Participant count weight
                if (chat.participants_count > 1000) score += 3;
                else if (chat.participants_count > 100) score += 2;
                else if (chat.participants_count > 10) score += 1;

                // Has username (public group)
                if (chat.username) score += 1;

                // Recent activity
                if (chat.last_message_date) {
                    const daysSinceLastMessage = (Date.now() - new Date(chat.last_message_date)) / (1000 * 60 * 60 * 24);
                    if (daysSinceLastMessage <= 7) score += 2;
                    else if (daysSinceLastMessage <= 30) score += 1;
                }

                return score;
            }

            getChatDisplayCategory(chat) {
                if (chat.is_broadcast) return 'Broadcast Channel';
                if (chat.is_megagroup) return 'Megagroup';
                if (chat.type === 'supergroup') return 'Supergroup';
                if (chat.type === 'channel') return 'Channel';
                return 'Group';
            }

            async loadConfiguredGroups() {
                try {
                    const response = await fetch(`${this.GROUPS_API_BASE}`);
                    if (response.ok) {
                        const data = await response.json();
                        this.configuredGroups = data.groups || [];
                    }
                } catch (error) {
                    console.error('❌ Error loading configured groups:', error);
                    this.configuredGroups = [];
                }
            }

            renderDiscoveredChats() {
                const container = document.getElementById('discoveredChats');
                let chats = [...this.discoveredChats];

                // Apply search filter
                if (this.searchTerm) {
                    chats = chats.filter(chat => 
                        chat.title?.toLowerCase().includes(this.searchTerm) ||
                        chat.username?.toLowerCase().includes(this.searchTerm) ||
                        chat.description?.toLowerCase().includes(this.searchTerm)
                    );
                }

                // Apply type filter
                if (this.currentFilter) {
                    chats = chats.filter(chat => chat.type === this.currentFilter);
                }

                // Filter out already configured chats
                const configuredIds = new Set(this.configuredGroups.map(g => g.id));
                chats = chats.filter(chat => !configuredIds.has(chat.id));

                // Update count
                document.getElementById('discoveredPanelCount').textContent = chats.length;

                if (chats.length === 0) {
                    container.innerHTML = this.getEmptyStateHTML('discovery');
                    return;
                }

                // Render chats with enhanced UI
                container.innerHTML = chats.map(chat => this.createDiscoveredChatHTML(chat)).join('');

                // Add staggered animation
                container.querySelectorAll('.chat-item').forEach((item, index) => {
                    item.style.animationDelay = `${index * 50}ms`;
                    item.classList.add('slide-in');
                });
            }

            createDiscoveredChatHTML(chat) {
                const avatar = this.getChatAvatar(chat);
                const memberCount = this.formatMemberCount(chat.participants_count);
                const chatType = this.formatChatType(chat.type);
                const relevanceScore = chat._isRelevant || 0;
                const category = chat._displayCategory || chatType;

                return `
                    <div class="chat-item" draggable="true" data-chat-id="${chat.id}" data-relevance="${relevanceScore}">
                        <div class="chat-avatar" style="${this.getChatAvatarStyle(chat)}">${avatar}</div>
                        <div class="chat-info">
                            <div class="chat-title" title="${chat.title || 'Unknown Chat'}">${chat.title || 'Unknown Chat'}</div>
                            <div class="chat-meta">
                                <div class="chat-meta-item">
                                    <i class="fas fa-users"></i>
                                    <span>${memberCount}</span>
                                </div>
                                <span class="chat-type ${chat.type}">${category}</span>
                                ${chat.username ? `<div class="chat-meta-item"><i class="fas fa-at"></i><span>${chat.username}</span></div>` : ''}
                                ${relevanceScore > 2 ? '<div class="chat-meta-item"><i class="fas fa-star" style="color: #f59e0b;" title="High relevance"></i></div>' : ''}
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="action-btn" onclick="groupsHub.quickConfigureChat(${chat.id})" title="Quick Configure">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="action-btn" onclick="groupsHub.previewChat(${chat.id})" title="Preview">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn" onclick="groupsHub.getChatStats(${chat.id})" title="Statistics">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            getChatAvatar(chat) {
                if (chat.title) {
                    // Use first letter of title
                    return chat.title.charAt(0).toUpperCase();
                }

                // Fallback based on type
                const typeIcons = {
                    'channel': '📢',
                    'supergroup': '👥',
                    'megagroup': '🌐',
                    'group': '💬'
                };

                return typeIcons[chat.type] || '❓';
            }

            getChatAvatarStyle(chat) {
                // Different gradient for different types
                const gradients = {
                    'channel': 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
                    'supergroup': 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                    'megagroup': 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                    'group': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
                };

                return `background: ${gradients[chat.type] || 'var(--primary-gradient)'}`;
            }

            renderConfiguredGroups() {
                const container = document.getElementById('configuredChats');

                // Update count
                document.getElementById('configuredPanelCount').textContent = this.configuredGroups.length;

                if (this.configuredGroups.length === 0) {
                    container.innerHTML = this.getEmptyStateHTML('configured');
                    return;
                }

                container.innerHTML = this.configuredGroups.map(group => this.createConfiguredGroupHTML(group)).join('');
            }

            createConfiguredGroupHTML(group) {
                const avatar = (group.title || 'Unknown').charAt(0).toUpperCase();
                const statusClass = group.is_active ? 'active' : (group.has_errors ? 'error' : '');
                const statusIndicator = group.is_active ? '' : (group.has_errors ? 'error' : 'warning');

                return `
                    <div class="configured-item ${statusClass}">
                        <div class="status-indicator ${statusIndicator}"></div>
                        <div class="chat-avatar">${avatar}</div>
                        <div class="chat-info">
                            <div class="chat-title">${group.title || 'Unknown Group'}</div>
                            <div class="chat-meta">
                                <div class="chat-meta-item">
                                    <i class="fas fa-${group.is_active ? 'play' : 'pause'}"></i>
                                    <span>${group.is_active ? 'Active' : 'Paused'}</span>
                                </div>
                                <div class="chat-meta-item">
                                    <i class="fas fa-message"></i>
                                    <span>${group.messages_count || 0} msgs</span>
                                </div>
                                <div class="chat-meta-item">
                                    <i class="fas fa-clock"></i>
                                    <span>${this.formatLastActivity(group.last_activity)}</span>
                                </div>
                            </div>
                        </div>
                        <div class="configured-actions">
                            <button class="action-btn" onclick="groupsHub.editGroup(${group.id})" title="Edit Configuration">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button class="action-btn" onclick="groupsHub.toggleGroup(${group.id})" title="${group.is_active ? 'Pause' : 'Resume'}">
                                <i class="fas fa-${group.is_active ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="action-btn" onclick="groupsHub.cloneGroup(${group.id})" title="Clone Configuration">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="action-btn" onclick="groupsHub.viewStats(${group.id})" title="View Statistics">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                            <button class="action-btn" onclick="groupsHub.removeGroup(${group.id})" title="Remove" style="color: #ef4444;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }

            getEmptyStateHTML(type) {
                if (type === 'discovery') {
                    return `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <h3>No groups found</h3>
                            <p>Try adjusting your search filters or run a new scan</p>
                        </div>
                    `;
                } else {
                    return `
                        <div class="empty-state">
                            <i class="fas fa-plus-circle"></i>
                            <h3>No groups configured yet</h3>
                            <p>Start by discovering groups or use the setup wizard</p>
                        </div>
                    `;
                }
            }

            formatMemberCount(count) {
                if (!count || count <= 1) return 'Unknown';
                if (count < 1000) return count.toString();
                if (count < 1000000) return (count / 1000).toFixed(1) + 'K';
                return (count / 1000000).toFixed(1) + 'M';
            }

            formatChatType(type) {
                if (!type) return 'Unknown';
                const typeMap = {
                    'group': 'Group',
                    'supergroup': 'Supergroup', 
                    'channel': 'Channel',
                    'megagroup': 'Megagroup'
                };
                return typeMap[type.toLowerCase()] || type;
            }

            formatLastActivity(activity) {
                if (!activity) return 'Unknown';
                const date = new Date(activity);
                const now = new Date();
                const diff = now - date;

                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;
                return date.toLocaleDateString();
            }

            updateUI() {
                this.renderDiscoveredChats();
                this.renderConfiguredGroups();
                this.updateStats();
            }

            updateStats() {
                document.getElementById('discoveredCount').textContent = this.discoveredChats.length;
                document.getElementById('configuredCount').textContent = this.configuredGroups.length;
                document.getElementById('activeCount').textContent = this.configuredGroups.filter(g => g.is_active).length;
            }

            // ============= ENHANCED ACTIONS =============

            async quickConfigureChat(chatId) {
                const chat = this.discoveredChats.find(c => c.id === chatId);
                if (!chat) {
                    this.showNotification('Chat not found', 'error');
                    return;
                }

                try {
                    this.showNotification(`⚙️ Configuring ${chat.title}...`, 'info');
                    
                    // Enhanced auto-configuration with intelligent defaults
                    const config = await this.generateSmartConfig(chat);
                    
                    const response = await fetch(`${this.DISCOVERY_API_BASE}/configure`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    
                    if (response.ok) {
                        // Add to configured groups immediately for instant UI feedback
                        this.configuredGroups.push({
                            id: chatId,
                            title: chat.title,
                            is_active: true,
                            has_errors: false,
                            messages_count: 0,
                            last_activity: new Date().toISOString()
                        });
                        
                        this.updateUI();
                        this.showNotification(`✅ ${chat.title} configured successfully!`, 'success');
                        this.animateItemMove(chatId);
                        
                        // Track success
                        this.trackEvent('quick_configure_success', { 
                            chat_id: chatId, 
                            chat_type: chat.type,
                            member_count: chat.participants_count 
                        });
                        
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || 'Configuration failed');
                    }
                } catch (error) {
                    console.error('Quick configure error:', error);
                    this.showNotification(`❌ Failed to configure ${chat.title}: ${error.message}`, 'error');
                    
                    // Track error
                    this.trackEvent('quick_configure_error', { 
                        chat_id: chatId, 
                        error: error.message 
                    });
                }
            }

            async generateSmartConfig(chat) {
                // Get available webhooks
                const webhooks = await this.getAvailableWebhooks();

                if (webhooks.length === 0) {
                    throw new Error('No Discord webhooks configured. Please add webhooks in settings.');
                }

                return {
                    chat_id: chat.id,
                    chat_title: chat.title,
                    enabled: true,
                    destination_webhook: this.selectOptimalWebhook(chat, webhooks),
                    filters: this.generateSmartFilters(chat),
                    transformations: this.generateSmartTransformations(chat)
                };
            }

            selectOptimalWebhook(chat, webhooks) {
                // For now, use round-robin. In future, implement load balancing
                const index = Math.abs(chat.id) % webhooks.length;
                return webhooks[index];
            }

            generateSmartFilters(chat) {
                return {
                    excludeBots: chat.type === 'channel', // Exclude bots in channels
                    includeMedia: true,
                    minLength: chat.participants_count > 1000 ? 10 : 0, // Longer messages for large groups
                    excludeForwards: chat.type === 'channel', // Reduce noise in channels
                    includePinned: true,
                    excludeEdited: false
                };
            }

            generateSmartTransformations(chat) {
                return {
                    prefix: chat.type === 'channel',
                    prefixText: chat.type === 'channel' ? `[${chat.title}] ` : '',
                    watermark: chat.participants_count > 100, // Enable watermarks for larger groups
                    embed: chat.participants_count > 50, // Use embeds for medium+ groups
                    mentionHandling: 'preserve', // Preserve mentions
                    linkPreview: true
                };
            }

            async getAvailableWebhooks() {
                try {
                    const response = await fetch('/api/config');
                    if (response.ok) {
                        const data = await response.json();
                        return data.webhooks || [];
                    }
                } catch (error) {
                    console.error('Error getting webhooks:', error);
                }
                return [];
            }

            async previewChat(chatId) {
                this.showNotification('Preview feature coming soon!', 'info');
            }

            async getChatStats(chatId) {
                this.showNotification('Statistics feature coming soon!', 'info');
            }

            async cloneGroup(groupId) {
                this.showNotification('Clone feature coming soon!', 'info');
            }

            async editGroup(groupId) {
                const group = this.configuredGroups.find(g => g.id === groupId);
                if (group) {
                    this.showNotification(`🔧 Edit configuration for ${group.title} (Coming soon)`, 'info');
                    this.trackEvent('edit_group_requested', { group_id: groupId });
                }
            }

            async toggleGroup(groupId) {
                const group = this.configuredGroups.find(g => g.id === groupId);
                if (!group) return;

                try {
                    const action = group.is_active ? 'disable' : 'enable';
                    const response = await fetch(`${this.GROUPS_API_BASE}/${groupId}/${action}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        group.is_active = !group.is_active;
                        this.updateUI();
                        this.showNotification(`✅ ${group.title} ${action}d successfully`, 'success');
                        
                        this.trackEvent('group_toggled', { 
                            group_id: groupId, 
                            new_state: group.is_active ? 'active' : 'inactive' 
                        });
                    } else {
                        throw new Error(`Failed to ${action} group`);
                    }
                } catch (error) {
                    console.error('Toggle group error:', error);
                    this.showNotification(`❌ Failed to toggle ${group.title}`, 'error');
                }
            }

            async removeGroup(groupId) {
                const group = this.configuredGroups.find(g => g.id === groupId);
                if (!group) return;

                if (!confirm(`Are you sure you want to remove "${group.title}" from configuration?`)) {
                    return;
                }

                try {
                    const response = await fetch(`${this.GROUPS_API_BASE}/${groupId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        this.configuredGroups = this.configuredGroups.filter(g => g.id !== groupId);
                        this.updateUI();
                        this.showNotification(`✅ ${group.title} removed successfully`, 'success');
                        this.trackEvent('group_removed', { group_id: groupId });
                    } else {
                        throw new Error('Remove failed');
                    }
                } catch (error) {
                    console.error('Remove group error:', error);
                    this.showNotification(`❌ Failed to remove ${group.title}`, 'error');
                }
            }

            async viewStats(groupId) {
                this.showNotification('Statistics dashboard coming soon!', 'info');
            }

            animateItemMove(chatId) {
                const sourceItem = document.querySelector(`[data-chat-id="${chatId}"]`);
                if (sourceItem) {
                    sourceItem.style.transform = 'translateX(100%) scale(0.8)';
                    sourceItem.style.opacity = '0';
                    
                    setTimeout(() => {
                        this.updateUI();
                    }, 300);
                }
            }

            // ============= REAL-TIME UPDATES & WEBSOCKET =============

            startRealTimeUpdates() {
                this.connectWebSocket();

                setInterval(() => {
                    if (!this.wsConnected) {
                        this.loadData();
                    }
                }, 30000);
            }

            connectWebSocket() {
                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    this.ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
                    
                    this.ws.onopen = () => {
                        console.log('🔗 Enhanced Groups Hub WebSocket connected');
                        this.wsConnected = true;
                        this.showNotification('Real-time updates connected', 'success');
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleRealTimeUpdate(data);
                        } catch (error) {
                            console.error('WebSocket message parse error:', error);
                        }
                    };
                    
                    this.ws.onclose = () => {
                        console.log('📪 WebSocket disconnected');
                        this.wsConnected = false;
                        setTimeout(() => this.connectWebSocket(), 5000);
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        this.wsConnected = false;
                    };
                    
                } catch (error) {
                    console.error('WebSocket connection failed:', error);
                    this.wsConnected = false;
                }
            }

            handleRealTimeUpdate(data) {
                switch (data.type) {
                    case 'chat_discovered':
                        const filteredChats = this.applyIntelligentFiltering([data.data]);
                        if (filteredChats.length > 0) {
                            this.discoveredChats.unshift(filteredChats[0]);
                            this.updateUI();
                            this.showNotification(`🎉 New group discovered: ${data.data.title}`, 'success');
                        }
                        break;
                        
                    case 'group_configured':
                        this.configuredGroups.unshift(data.data);
                        this.updateUI();
                        this.showNotification(`⚙️ Group configured: ${data.data.title}`, 'info');
                        break;
                        
                    case 'group_status_changed':
                        const group = this.configuredGroups.find(g => g.id === data.data.id);
                        if (group) {
                            Object.assign(group, data.data);
                            this.updateUI();
                        }
                        break;
                        
                    case 'message_processed':
                        this.updateMessageCounts(data.data);
                        break;
                        
                    case 'discovery_scan_completed':
                        this.loadDiscoveredChats();
                        this.showNotification(`🔍 Discovery scan completed: ${data.data.new_chats} new groups found`, 'success');
                        break;
                        
                    default:
                        console.log('Unknown WebSocket message type:', data.type);
                }
            }

            updateMessageCounts(data) {
                const group = this.configuredGroups.find(g => g.id === data.group_id);
                if (group) {
                    group.messages_count = (group.messages_count || 0) + 1;
                    group.last_activity = new Date().toISOString();
                    this.renderConfiguredGroups();
                }

                const current = parseInt(document.getElementById('groupsToday').textContent) || 0;
                document.getElementById('groupsToday').textContent = current + 1;
            }

            // ============= ENHANCED UTILITIES =============

            showNotification(message, type = 'info') {
                document.querySelectorAll('.notification').forEach(n => n.remove());

                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-${this.getNotificationIcon(type)}"></i>
                        <span>${message}</span>
                    </div>
                `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        notification.style.animation = 'slideOutRight 0.3s ease-out';
                        setTimeout(() => {
                            if (document.body.contains(notification)) {
                                document.body.removeChild(notification);
                            }
                        }, 300);
                    }
                }, 5000);
            }

            getNotificationIcon(type) {
                const icons = {
                    'success': 'check-circle',
                    'error': 'exclamation-circle',
                    'warning': 'exclamation-triangle',
                    'info': 'info-circle'
                };
                return icons[type] || 'info-circle';
            }

            async refreshDiscovery() {
                try {
                    this.showNotification('🔄 Starting discovery scan...', 'info');
                    
                    const response = await fetch(`${this.DISCOVERY_API_BASE}/scan`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ force_refresh: true })
                    });
                    
                    if (response.ok) {
                        this.showNotification('✅ Discovery scan started successfully', 'success');
                        
                        setTimeout(async () => {
                            await this.loadData();
                            this.updateUI();
                            this.showNotification('🎉 Discovery data refreshed', 'success');
                        }, 5000);
                        
                        this.trackEvent('manual_refresh_triggered');
                        
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.detail || 'Scan failed');
                    }
                } catch (error) {
                    console.error('Refresh discovery error:', error);
                    this.showNotification(`❌ Failed to start discovery scan: ${error.message}`, 'error');
                }
            }

            trackEvent(eventName, properties = {}) {
                const event = {
                    name: eventName,
                    timestamp: new Date().toISOString(),
                    properties: {
                        ...properties,
                        discovered_count: this.discoveredChats.length,
                        configured_count: this.configuredGroups.length,
                        active_count: this.configuredGroups.filter(g => g.is_active).length,
                        current_filter: this.currentFilter,
                        search_term: this.searchTerm ? 'has_search' : 'no_search'
                    }
                };

                console.log('📊 Event tracked:', event);
            }
        }

        // ============= GLOBAL FUNCTIONS =============

        function startWizard() {
            if (groupsHub) {
                groupsHub.showNotification('🧙‍♂️ Setup Wizard coming soon! For now, use the Scan Chats button.', 'info');
                groupsHub.trackEvent('wizard_requested');
            }
        }

        function refreshDiscovery() {
            if (groupsHub) {
                groupsHub.refreshDiscovery();
            }
        }

        // ============= GLOBAL INITIALIZATION =============

        let groupsHub;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('🎭 Starting Enhanced Groups Hub...');
                groupsHub = new EnhancedGroupsHub();
            } catch (error) {
                console.error('❌ Failed to initialize Groups Hub:', error);

                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; color: white; text-align: center; padding: 2rem;">
                        <div style="background: var(--bg-card); padding: 3rem; border-radius: 20px; border: 1px solid var(--border-glass); backdrop-filter: blur(20px); max-width: 500px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #f59e0b; margin-bottom: 1rem;"></i>
                            <h2 style="margin-bottom: 1rem;">Groups Hub Failed to Load</h2>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; line-height: 1.6;">
                                There was an error initializing the Groups Hub. This usually happens when:<br><br>
                                • Discovery Service is not running (port 8002)<br>
                                • Network connectivity issues<br>
                                • Browser compatibility problems
                            </p>
                            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                                <button onclick="location.reload()" style="padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-refresh"></i> Retry
                                </button>
                                <button onclick="window.open('/health', '_blank')" style="padding: 0.75rem 1.5rem; background: var(--bg-glass); color: white; border: 1px solid var(--border-glass); border-radius: 12px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-stethoscope"></i> Check Health
                                </button>
                            </div>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 1.5rem;">
                                Error details available in browser console (F12)
                            </p>
                        </div>
                    </div>
                `;
            }
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            if (groupsHub) {
                groupsHub.showNotification('An unexpected error occurred. Please refresh the page.', 'error');
            }
        });

        // Performance monitoring
        window.addEventListener('load', () => {
            const loadTime = performance.now();
            console.log(`🚀 Groups Hub loaded in ${loadTime.toFixed(2)}ms`);

            if (groupsHub) {
                groupsHub.trackEvent('page_loaded', { load_time: loadTime });
            }
        });

        // Enhanced network monitoring
        window.addEventListener('online', () => {
            if (groupsHub) {
                groupsHub.showNotification('🌐 Connection restored', 'success');
                groupsHub.trackEvent('network_online');

                if (!groupsHub.wsConnected) {
                    setTimeout(() => groupsHub.connectWebSocket(), 1000);
                }
            }
        });

        window.addEventListener('offline', () => {
            if (groupsHub) {
                groupsHub.showNotification('📡 Connection lost - working offline', 'warning');
                groupsHub.trackEvent('network_offline');
            }
        });

        // Debug helpers for development
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            window.groupsHubDebug = {
                reload: () => location.reload(),
                clearCache: () => {
                    localStorage.clear();
                    sessionStorage.clear();
                    location.reload();
                },
                testNotification: (type = 'info') => {
                    if (groupsHub) {
                        groupsHub.showNotification(`Test ${type} notification`, type);
                    }
                },
                showStats: () => {
                    if (groupsHub) {
                        console.table({
                            'Discovered Chats': groupsHub.discoveredChats.length,
                            'Configured Groups': groupsHub.configuredGroups.length,
                            'Active Groups': groupsHub.configuredGroups.filter(g => g.is_active).length,
                            'WebSocket Connected': groupsHub.wsConnected,
                            'Current Filter': groupsHub.currentFilter || 'None',
                            'Search Term': groupsHub.searchTerm || 'None'
                        });
                    }
                },
                forceRefresh: () => {
                    if (groupsHub) {
                        groupsHub.loadData().then(() => {
                            groupsHub.updateUI();
                            console.log('✅ Forced refresh completed');
                        });
                    }
                }
            };

            console.log('🛠️ Debug helpers available:');
            console.log('  groupsHubDebug.reload() - Reload page');
            console.log('  groupsHubDebug.clearCache() - Clear cache and reload');
            console.log('  groupsHubDebug.testNotification(type) - Test notifications');
            console.log('  groupsHubDebug.showStats() - Show current stats');
            console.log('  groupsHubDebug.forceRefresh() - Force data refresh');
        }

        // Memory cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (groupsHub) {
                if (groupsHub.ws) {
                    groupsHub.ws.close();
                }

                if (groupsHub.updateInterval) {
                    clearInterval(groupsHub.updateInterval);
                }

                groupsHub.trackEvent('page_unload');
            }
        });

        console.log('🎭 Enhanced Groups Hub Enterprise - Fully Loaded');
        console.log('📋 Features enabled:');
        console.log('  ✅ Intelligent group filtering');
        console.log('  ✅ Real-time WebSocket updates');
        console.log('  ✅ Enhanced drag & drop');
        console.log('  ✅ Smart auto-configuration');
        console.log('  ✅ Performance monitoring');
        console.log('  ✅ Network status monitoring');
        console.log('  ✅ Error boundary handling');

        class DashboardManager {
    constructor() {
        this.baseUrl = window.location.origin;
        this.websocket = null;
        this.groups = [];
        this.selectedGroups = new Set();
        this.init();
    }

    async init() {
        console.log('🚀 Inicializando Dashboard Manager...');
        
        // Conectar WebSocket
        this.connectWebSocket();
        
        // Cargar datos iniciales
        await this.loadGroups();
        
        // Setup event listeners
        this.setupEventListeners();
        
        // Auto-refresh cada 30 segundos
        setInterval(() => this.loadGroups(), 30000);
    }

    connectWebSocket() {
        try {
            const wsUrl = `ws://${window.location.host}/ws`;
            this.websocket = new WebSocket(wsUrl);
            
            this.websocket.onopen = () => {
                console.log('✅ WebSocket conectado');
            };
            
            this.websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'stats_update') {
                    this.updateStats(data.data);
                }
            };
            
            this.websocket.onclose = () => {
                console.log('🔄 WebSocket desconectado, reintentando...');
                setTimeout(() => this.connectWebSocket(), 5000);
            };
            
        } catch (error) {
            console.error('❌ Error WebSocket:', error);
        }
    }

    async loadGroups() {
        try {
            console.log('📡 Cargando grupos...');
            
            const response = await fetch(`${this.baseUrl}/api/groups`);
            const result = await response.json();
            
            if (result.status === 'success') {
                this.groups = result.data.groups;
                this.renderGroups();
                this.updateSummary(result.data);
                console.log(`✅ ${this.groups.length} grupos cargados`);
            } else {
                console.error('❌ Error cargando grupos:', result.message);
                this.showNotification('Error cargando grupos', 'error');
            }
            
        } catch (error) {
            console.error('❌ Error en loadGroups:', error);
            this.showNotification('Error de conexión', 'error');
        }
    }

    renderGroups() {
        // Render discovered groups
        const discoveredContainer = document.querySelector('.discovered-groups-container');
        if (discoveredContainer) {
            const discoveredGroups = this.groups.filter(g => !g.configured);
            discoveredContainer.innerHTML = this.renderGroupsList(discoveredGroups, 'discovered');
        }

        // Render configured groups  
        const configuredContainer = document.querySelector('.configured-groups-container');
        if (configuredContainer) {
            const configuredGroups = this.groups.filter(g => g.configured);
            configuredContainer.innerHTML = this.renderGroupsList(configuredGroups, 'configured');
        }

        // Update counters
        this.updateCounters();
    }

    renderGroupsList(groups, type) {
        if (groups.length === 0) {
            return `
                <div class="empty-state">
                    <i class="fas fa-inbox fa-2x"></i>
                    <p>No ${type} groups found</p>
                </div>
            `;
        }

        return groups.map(group => this.renderGroupCard(group, type)).join('');
    }

    renderGroupCard(group, type) {
        const statusIcon = group.enabled ? '▶️' : '⏸️';
        const statusClass = group.enabled ? 'active' : 'paused';
        
        return `
            <div class="group-card ${statusClass}" data-group-id="${group.id}">
                <div class="group-header">
                    <div class="group-icon">
                        ${group.title.charAt(0).toUpperCase()}
                    </div>
                    <div class="group-info">
                        <h3 class="group-title">${group.title}</h3>
                        <div class="group-meta">
                            <span class="group-type">${group.type}</span>
                            <span class="group-participants">${group.participants} members</span>
                        </div>
                    </div>
                    <div class="group-status">
                        <span class="status-indicator ${statusClass}"></span>
                        <span class="status-text">${group.enabled ? 'Active' : 'Paused'}</span>
                    </div>
                </div>
                
                <div class="group-actions">
                    ${type === 'configured' ? `
                        <button class="btn-action settings" onclick="dashboardManager.openGroupSettings('${group.id}')" title="Settings">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="btn-action toggle ${statusClass}" onclick="dashboardManager.toggleGroup('${group.id}')" title="${group.enabled ? 'Pause' : 'Resume'}">
                            <i class="fas fa-${group.enabled ? 'pause' : 'play'}"></i>
                        </button>
                        <button class="btn-action copy" onclick="dashboardManager.copyGroupConfig('${group.id}')" title="Copy">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn-action delete" onclick="dashboardManager.removeGroup('${group.id}')" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    ` : `
                        <button class="btn-action add" onclick="dashboardManager.addGroup('${group.id}')" title="Add to monitoring">
                            <i class="fas fa-plus"></i>
                        </button>
                    `}
                </div>
                
                ${type === 'configured' && group.webhook_url ? `
                    <div class="group-webhook">
                        <small>Webhook: ${group.webhook_url.substring(0, 50)}...</small>
                    </div>
                ` : ''}
            </div>
        `;
    }

    updateCounters() {
        // Update discovered counter
        const discoveredCounter = document.querySelector('.discovered-counter');
        if (discoveredCounter) {
            const count = this.groups.filter(g => !g.configured).length;
            discoveredCounter.textContent = count;
        }

        // Update configured counter  
        const configuredCounter = document.querySelector('.configured-counter');
        if (configuredCounter) {
            const count = this.groups.filter(g => g.configured).length;
            configuredCounter.textContent = count;
        }
    }

    updateSummary(data) {
        // Update summary stats
        const elements = {
            'total-groups': data.total,
            'configured-groups': data.configured, 
            'active-groups': data.active
        };

        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        });
    }

    async toggleGroup(groupId) {
        try {
            console.log(`🔄 Toggling group ${groupId}...`);
            
            const response = await fetch(`${this.baseUrl}/api/groups/${groupId}/toggle`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                console.log(`✅ Group ${groupId} toggled successfully`);
                this.showNotification(result.message, 'success');
                await this.loadGroups(); // Reload to update UI
            } else {
                console.error('❌ Error toggling group:', result.message);
                this.showNotification('Error toggling group', 'error');
            }
            
        } catch (error) {
            console.error('❌ Error in toggleGroup:', error);
            this.showNotification('Connection error', 'error');
        }
    }

    async addGroup(groupId) {
        try {
            console.log(`➕ Adding group ${groupId}...`);
            
            // Find group info
            const group = this.groups.find(g => g.id == groupId);
            if (!group) {
                this.showNotification('Group not found', 'error');
                return;
            }

            // Show webhook configuration dialog
            const webhookUrl = prompt('Enter Discord webhook URL for this group:');
            if (!webhookUrl) return;

            const config = {
                enabled: true,
                group_name: group.title,
                webhook_url: webhookUrl,
                filters: {},
                watermark_enabled: false
            };

            const response = await fetch(`${this.baseUrl}/api/groups/${groupId}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });

            const result = await response.json();

            if (result.status === 'success') {
                console.log(`✅ Group ${groupId} added successfully`);
                this.showNotification('Group added successfully', 'success');
                await this.loadGroups();
            } else {
                console.error('❌ Error adding group:', result.message);
                this.showNotification('Error adding group', 'error');
            }

        } catch (error) {
            console.error('❌ Error in addGroup:', error);
            this.showNotification('Connection error', 'error');
        }
    }

    async removeGroup(groupId) {
        if (!confirm('Are you sure you want to remove this group from monitoring?')) {
            return;
        }

        try {
            console.log(`🗑️ Removing group ${groupId}...`);
            
            const response = await fetch(`${this.baseUrl}/api/groups/${groupId}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: false, webhook_url: null })
            });

            const result = await response.json();

            if (result.status === 'success') {
                console.log(`✅ Group ${groupId} removed successfully`);
                this.showNotification('Group removed successfully', 'success');
                await this.loadGroups();
            } else {
                console.error('❌ Error removing group:', result.message);
                this.showNotification('Error removing group', 'error');
            }

        } catch (error) {
            console.error('❌ Error in removeGroup:', error);
            this.showNotification('Connection error', 'error');
        }
    }

    openGroupSettings(groupId) {
        // Find group
        const group = this.groups.find(g => g.id == groupId);
        if (!group) return;

        // Create and show settings modal
        const modal = this.createSettingsModal(group);
        document.body.appendChild(modal);
        modal.style.display = 'flex';
    }

    createSettingsModal(group) {
        const modal = document.createElement('div');
        modal.className = 'settings-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Settings for ${group.title}</h3>
                    <button class="modal-close" onclick="this.closest('.settings-modal').remove()">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Webhook URL:</label>
                        <input type="url" id="webhook-url" value="${group.webhook_url || ''}" placeholder="https://discord.com/api/webhooks/...">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="watermark-enabled" ${group.watermark_enabled ? 'checked' : ''}>
                            Enable Watermarks
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="group-enabled" ${group.enabled ? 'checked' : ''}>
                            Enable Monitoring
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" onclick="this.closest('.settings-modal').remove()">Cancel</button>
                    <button class="btn-save" onclick="dashboardManager.saveGroupSettings('${group.id}', this.closest('.settings-modal'))">Save</button>
                </div>
            </div>
        `;

        // Add styles
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center;
            z-index: 10000;
        `;

        return modal;
    }

    async saveGroupSettings(groupId, modal) {
        try {
            const webhookUrl = modal.querySelector('#webhook-url').value;
            const watermarkEnabled = modal.querySelector('#watermark-enabled').checked;
            const groupEnabled = modal.querySelector('#group-enabled').checked;

            const config = {
                webhook_url: webhookUrl,
                watermark_enabled: watermarkEnabled,
                enabled: groupEnabled
            };

            const response = await fetch(`${this.baseUrl}/api/groups/${groupId}/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });

            const result = await response.json();

            if (result.status === 'success') {
                this.showNotification('Settings saved successfully', 'success');
                modal.remove();
                await this.loadGroups();
            } else {
                this.showNotification('Error saving settings', 'error');
            }

        } catch (error) {
            console.error('❌ Error saving settings:', error);
            this.showNotification('Connection error', 'error');
        }
    }

    copyGroupConfig(groupId) {
        const group = this.groups.find(g => g.id == groupId);
        if (!group) return;

        const config = {
            webhook_url: group.webhook_url,
            filters: group.filters,
            watermark_enabled: group.watermark_enabled,
            enabled: group.enabled
        };

        navigator.clipboard.writeText(JSON.stringify(config, null, 2)).then(() => {
            this.showNotification('Configuration copied to clipboard', 'success');
        }).catch(() => {
            this.showNotification('Failed to copy configuration', 'error');
        });
    }

    setupEventListeners() {
        // Search functionality
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.filterGroups(e.target.value);
            });
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const filter = e.target.dataset.filter;
                this.applyFilter(filter);
            });
        });

        // Bulk actions
        const bulkActionBtn = document.querySelector('.bulk-action-btn');
        if (bulkActionBtn) {
            bulkActionBtn.addEventListener('click', () => {
                this.performBulkAction();
            });
        }

        // Refresh button
        const refreshBtn = document.querySelector('.refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                this.loadGroups();
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        this.loadGroups();
                        break;
                    case 'a':
                        e.preventDefault();
                        this.selectAllGroups();
                        break;
                }
            }
        });
    }

    filterGroups(searchTerm) {
        const cards = document.querySelectorAll('.group-card');
        cards.forEach(card => {
            const title = card.querySelector('.group-title').textContent.toLowerCase();
            const visible = title.includes(searchTerm.toLowerCase());
            card.style.display = visible ? 'block' : 'none';
        });
    }

    applyFilter(filter) {
        const cards = document.querySelectorAll('.group-card');
        
        // Update active filter button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

        // Apply filter
        cards.forEach(card => {
            const groupId = card.dataset.groupId;
            const group = this.groups.find(g => g.id == groupId);
            let visible = true;

            switch(filter) {
                case 'all':
                    visible = true;
                    break;
                case 'active':
                    visible = group && group.enabled;
                    break;
                case 'paused':
                    visible = group && !group.enabled;
                    break;
                case 'configured':
                    visible = group && group.configured;
                    break;
                case 'unconfigured':
                    visible = group && !group.configured;
                    break;
            }

            card.style.display = visible ? 'block' : 'none';
        });
    }

    selectAllGroups() {
        const checkboxes = document.querySelectorAll('.group-card input[type="checkbox"]');
        const allSelected = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(cb => {
            cb.checked = !allSelected;
            const groupId = cb.closest('.group-card').dataset.groupId;
            if (cb.checked) {
                this.selectedGroups.add(groupId);
            } else {
                this.selectedGroups.delete(groupId);
            }
        });

        this.updateBulkActionsVisibility();
    }

    updateBulkActionsVisibility() {
        const bulkActionsContainer = document.querySelector('.bulk-actions');
        if (bulkActionsContainer) {
            bulkActionsContainer.style.display = this.selectedGroups.size > 0 ? 'flex' : 'none';
        }
    }

    async performBulkAction() {
        const action = document.querySelector('.bulk-action-select').value;
        if (!action || this.selectedGroups.size === 0) return;

        const groupIds = Array.from(this.selectedGroups);
        
        try {
            console.log(`🔄 Performing bulk action: ${action} on ${groupIds.length} groups`);

            const requestBody = {
                group_ids: groupIds.map(id => parseInt(id)),
                operation: action,
                config: {}
            };

            // Add specific config for configure action
            if (action === 'configure') {
                const webhookUrl = prompt('Enter Discord webhook URL for selected groups:');
                if (!webhookUrl) return;
                requestBody.config = { webhook_url: webhookUrl, enabled: true };
            }

            const response = await fetch(`${this.baseUrl}/api/groups/bulk`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            const result = await response.json();

            if (result.status === 'success') {
                const successCount = result.data.filter(r => r.status === 'success').length;
                this.showNotification(`Bulk action completed on ${successCount} groups`, 'success');
                
                // Clear selection
                this.selectedGroups.clear();
                this.updateBulkActionsVisibility();
                
                // Reload groups
                await this.loadGroups();
            } else {
                this.showNotification('Bulk action failed', 'error');
            }

        } catch (error) {
            console.error('❌ Error in bulk action:', error);
            this.showNotification('Connection error', 'error');
        }
    }

    updateStats(data) {
        try {
            // Update replicator stats
            if (data.replicator && data.replicator.data) {
                const stats = data.replicator.data;
                this.updateStatElement('messages-replicated', stats.messages_replicated || 0);
                this.updateStatElement('images-processed', stats.images_processed || 0);
                this.updateStatElement('videos-processed', stats.videos_processed || 0);
                this.updateStatElement('errors-count', stats.errors || 0);
                this.updateStatElement('uptime-hours', Math.round(stats.uptime_hours || 0));
                this.updateStatElement('success-rate', Math.round(stats.success_rate || 0));
            }

            // Update discovery stats
            if (data.discovery) {
                const discoveryStats = data.discovery;
                this.updateStatElement('discovered-chats', discoveryStats.total_chats || 0);
                this.updateStatElement('scan-progress', discoveryStats.scan_progress || 0);
            }

        } catch (error) {
            console.error('❌ Error updating stats:', error);
        }
    }

    updateStatElement(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            // Animate value change
            const currentValue = parseInt(element.textContent) || 0;
            if (currentValue !== value) {
                element.style.transform = 'scale(1.1)';
                element.textContent = value;
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 200);
            }
        }
    }

    showNotification(message, type = 'info') {
        // Remove existing notifications
        document.querySelectorAll('.notification').forEach(n => n.remove());

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
            </div>
        `;

        // Add styles
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
            color: white; padding: 1rem; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        `;

        document.body.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // Export/Import functionality
    async exportConfiguration() {
        try {
            const configuredGroups = this.groups.filter(g => g.configured);
            const exportData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                groups: configuredGroups.map(g => ({
                    id: g.id,
                    title: g.title,
                    webhook_url: g.webhook_url,
                    filters: g.filters,
                    watermark_enabled: g.watermark_enabled,
                    enabled: g.enabled
                }))
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `replicator-config-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            this.showNotification('Configuration exported successfully', 'success');

        } catch (error) {
            console.error('❌ Error exporting configuration:', error);
            this.showNotification('Error exporting configuration', 'error');
        }
    }

    async importConfiguration(file) {
        try {
            const text = await file.text();
            const importData = JSON.parse(text);

            if (!importData.groups || !Array.isArray(importData.groups)) {
                throw new Error('Invalid configuration file format');
            }

            let importedCount = 0;
            for (const groupConfig of importData.groups) {
                try {
                    const response = await fetch(`${this.baseUrl}/api/groups/${groupConfig.id}/config`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(groupConfig)
                    });

                    if (response.ok) {
                        importedCount++;
                    }
                } catch (error) {
                    console.error(`Error importing group ${groupConfig.id}:`, error);
                }
            }

            this.showNotification(`Successfully imported ${importedCount} group configurations`, 'success');
            await this.loadGroups();

        } catch (error) {
            console.error('❌ Error importing configuration:', error);
            this.showNotification('Error importing configuration', 'error');
        }
    }

    // System status monitoring
    async checkSystemStatus() {
        try {
            const response = await fetch(`${this.baseUrl}/api/system/status`);
            const result = await response.json();

            if (result.status === 'success') {
                this.updateSystemStatus(result.data);
            }

        } catch (error) {
            console.error('❌ Error checking system status:', error);
        }
    }

    updateSystemStatus(statusData) {
        const services = statusData.services;
        
        Object.entries(services).forEach(([serviceName, serviceData]) => {
            const statusElement = document.querySelector(`[data-service="${serviceName}"] .service-status`);
            if (statusElement) {
                statusElement.className = `service-status ${serviceData.status}`;
                statusElement.textContent = serviceData.status;
            }
        });
    }
}

// CSS styles for the dashboard components
const dashboardStyles = `
<style>
.notification {
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.settings-modal .modal-content {
    background: rgba(30, 41, 59, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 2rem;
    min-width: 400px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.modal-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.3s;
}

.modal-close:hover { opacity: 1; }

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: rgba(255, 255, 255, 0.9);
}

.form-group input[type="url"],
.form-group input[type="text"] {
    width: 100%;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: white;
}

.form-group input[type="checkbox"] {
    margin-right: 0.5rem;
}

.modal-footer {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-cancel, .btn-save {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-cancel {
    background: rgba(255, 255, 255, 0.1);
    color: white;
}

.btn-save {
    background: #10b981;
    color: white;
}

.btn-cancel:hover { background: rgba(255, 255, 255, 0.2); }
.btn-save:hover { background: #059669; }

.group-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s;
}

.group-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.group-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.group-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
}

.group-info {
    flex: 1;
}

.group-title {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.group-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    opacity: 0.7;
}

.group-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #10b981;
}

.status-indicator.paused {
    background: #f59e0b;
}

.group-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-action {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-action:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

.btn-action.delete:hover { background: #ef4444; }
.btn-action.add:hover { background: #10b981; }
.btn-action.toggle.active:hover { background: #f59e0b; }

.empty-state {
    text-align: center;
    padding: 3rem;
    opacity: 0.5;
}

.bulk-actions {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(30, 41, 59, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 1rem;
    display: none;
    gap: 1rem;
    align-items: center;
    z-index: 1000;
}
</style>
`;

// Initialize dashboard manager when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Inject styles
    document.head.insertAdjacentHTML('beforeend', dashboardStyles);
    
    // Initialize dashboard manager
    window.dashboardManager = new DashboardManager();
    
    console.log('✅ Dashboard Manager initialized successfully');
});

// Export functionality for external use
if (typeof module !== 'undefined' && module.exports) {
    module.exports = DashboardManager;
}
    </script>
</body>
</html>