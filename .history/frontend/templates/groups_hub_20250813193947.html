<button class="btn btn-primary" onclick="refreshAllData()">
    <i class="fas fa-sync"></i>
    Refresh Data
</button>
<a href="/dashboard" class="btn" style="background: var(--bg-glass);">
    <i class="fas fa-arrow-left"></i>
    Dashboard
</a>
</div>
</header>

<!-- Enhanced Performance Metrics -->
<div class="metrics-bar slide-in">
<div class="metric-group">
<div class="metric-item">
    <div class="metric-icon" id="discoveryServiceStatus"></div>
    <span class="metric-text">Discovery Service</span>
</div>
<div class="metric-item">
    <div class="metric-icon" id="replicatorServiceStatus"></div>
    <span class="metric-text">Message Replicator</span>
</div>
<div class="metric-item">
    <div class="metric-icon" id="systemStatus"></div>
    <span class="metric-text">System Online</span>
</div>
</div>
<div class="metric-group">
<div class="metric-item">
    <span class="metric-text">Last scan: <strong id="lastScan">Never</strong></span>
</div>
<div class="metric-item">
    <span class="metric-text">Groups found: <strong id="groupsToday">0</strong></span>
</div>
</div>
</div>

<!-- Main Layout -->
<div class="main-layout">
<!-- Discovery Panel Enhanced -->
<div class="panel discovery-panel slide-in">
<div class="panel-header">
    <div class="panel-title">
        <i class="fas fa-search"></i>
        Discovered Groups & Channels
        <span class="panel-count" id="discoveredPanelCount">0</span>
    </div>
</div>

<div class="discovery-controls">
    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" placeholder="Search groups and channels..." id="discoverySearch">
    </div>
    <div class="filter-group">
        <button class="filter-btn active" data-filter="">All Types</button>
        <button class="filter-btn" data-filter="channel">Channels</button>
        <button class="filter-btn" data-filter="supergroup">Supergroups</button>
        <button class="filter-btn" data-filter="group">Groups</button>
    </div>
</div>

<div class="chat-list" id="discoveredChats">
    <div class="loading-state">
        <i class="fas fa-spinner loading-spinner"></i>
        <h3>Loading discovered groups...</h3>
        <p>Connecting to Discovery Service...</p>
    </div>
</div>
</div>

<!-- Configured Panel Enhanced -->
<div class="panel configured-panel slide-in">
<div class="panel-header">
    <div class="panel-title">
        <i class="fas fa-cogs"></i>
        Configured Groups
        <span class="panel-count" id="configuredPanelCount">0</span>
    </div>
</div>

<div class="drop-zone" id="dropZone">
    <div class="drop-message">
        <i class="fas fa-hand-point-right"></i>
        <strong>Drag groups here to configure</strong><br>
        Auto-setup with smart defaults
    </div>
</div>

<div class="chat-list" id="configuredChats">
    <div class="empty-state">
        <i class="fas fa-plus-circle"></i>
        <h3>No groups configured yet</h3>
        <p>Start by discovering groups or drag them here to configure</p>
    </div>
</div>
</div>
</div>
</div>

<!-- System Status Indicator -->
<div class="system-status online" id="systemStatusIndicator">
<i class="fas fa-circle" style="color: #10b981;"></i>
<span>System Online</span>
</div>

<script>
// ============= ENHANCED GROUPS HUB APPLICATION =============
class EnterpriseGroupsHub {
constructor() {
this.discoveredChats = [];
this.configuredGroups = [];
this.draggedItem = null;
this.searchTerm = '';
this.currentFilter = '';
this.isLoading = false;
this.systemHealth = {
    discovery: false,
    replicator: false,
    orchestrator: true
};

// API endpoints
this.API = {
    discovery: {
        chats: '/api/discovery/chats',
        scan: '/api/discovery/scan',
        status: '/api/discovery/status'
    },
    replicator: {
        groups: '/api/config/groups',
        addGroup: '/api/config/add_group',
        health: 'http://localhost:8001/health'
    },
    groups: {
        all: '/api/groups/all',
        configure: '/api/groups/configure'
    }
};

this.init();
}

async init() {
console.log('üé≠ Initializing Enterprise Groups Hub...');

try {
    await this.checkSystemHealth();
    await this.loadData();
    this.setupEventListeners();
    this.setupDragAndDrop();
    this.updateUI();
    this.startRealTimeUpdates();
    
    console.log('‚úÖ Enterprise Groups Hub ready');
} catch (error) {
    console.error('‚ùå Failed to initialize Groups Hub:', error);
    this.showNotification('Failed to initialize Groups Hub', 'error');
}
}

async checkSystemHealth() {
console.log('üîç Checking system health...');

// Check Discovery Service
try {
    const discoveryResponse = await fetch('/api/discovery/chats?limit=1');
    this.systemHealth.discovery = discoveryResponse.ok;
} catch {
    this.systemHealth.discovery = false;
}

// Check Message Replicator
try {
    const replicatorResponse = await fetch('http://localhost:8001/health');
    this.systemHealth.replicator = replicatorResponse.ok;
} catch {
    this.systemHealth.replicator = false;
}

this.updateSystemHealthUI();
}

updateSystemHealthUI() {
const discoveryIcon = document.getElementById('discoveryServiceStatus');
const replicatorIcon = document.getElementById('replicatorServiceStatus');
const systemIcon = document.getElementById('systemStatus');
const systemIndicator = document.getElementById('systemStatusIndicator');

// Update discovery service status
if (this.systemHealth.discovery) {
    discoveryIcon.className = 'metric-icon';
} else {
    discoveryIcon.className = 'metric-icon error';
}

// Update replicator service status
if (this.systemHealth.replicator) {
    replicatorIcon.className = 'metric-icon';
} else {
    replicatorIcon.className = 'metric-icon error';
}

// Update overall system status
const allHealthy = this.systemHealth.discovery && this.systemHealth.replicator;
if (allHealthy) {
    systemIcon.className = 'metric-icon';
    systemIndicator.className = 'system-status online';
    systemIndicator.innerHTML = '<i class="fas fa-circle" style="color: #10b981;"></i><span>System Online</span>';
} else {
    systemIcon.className = 'metric-icon warning';
    systemIndicator.className = 'system-status offline';
    systemIndicator.innerHTML = '<i class="fas fa-circle" style="color: #ef4444;"></i><span>Service Issues</span>';
}
}

setupEventListeners() {
// Enhanced search with debouncing
let searchTimeout;
const searchInput = document.getElementById('discoverySearch');
if (searchInput) {
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            this.searchTerm = e.target.value.toLowerCase().trim();
            this.renderDiscoveredChats();
        }, 300);
    });
}

// Enhanced filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        this.currentFilter = e.target.dataset.filter;
        this.renderDiscoveredChats();
    });
});

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        searchInput?.focus();
    }
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        this.refreshAllData();
    }
});
}

setupDragAndDrop() {
const dropZone = document.getElementById('dropZone');
if (!dropZone) return;

// Enhanced drag start
document.addEventListener('dragstart', (e) => {
    if (e.target.closest('.chat-item')) {
        this.draggedItem = e.target.closest('.chat-item');
        dropZone.classList.add('active');
        e.target.closest('.chat-item').classList.add('dragging');
        
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', e.target.closest('.chat-item').outerHTML);
    }
});

document.addEventListener('dragend', (e) => {
    dropZone.classList.remove('active');
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('dragging');
    });
    this.draggedItem = null;
});

// Enhanced drop functionality
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
});

dropZone.addEventListener('drop', async (e) => {
    e.preventDefault();
    if (this.draggedItem) {
        const chatId = parseInt(this.draggedItem.dataset.chatId);
        await this.quickConfigureChat(chatId);
    }
});
}

async loadData() {
if (this.isLoading) return;
this.isLoading = true;

try {
    console.log('üì° Loading data from services...');
    
    await Promise.all([
        this.loadDiscoveredChats(),
        this.loadConfiguredGroups()
    ]);
    
} catch (error) {
    console.error('‚ùå Error loading data:', error);
    this.showNotification('Failed to load data. Check service connectivity.', 'error');
} finally {
    this.isLoading = false;
}
}

async loadDiscoveredChats() {
try {
    console.log('üîç Loading discovered chats...');
    
    if (!this.systemHealth.discovery) {
        console.warn('‚ö†Ô∏è Discovery Service not available - using fallback');
        this.discoveredChats = this.getFallbackChats();
        return;
    }

    const params = new URLSearchParams({
        limit: '100',
        chat_type: 'group,supergroup,channel',
        is_private: 'false'
    });
    
    const response = await fetch(`${this.API.discovery.chats}?${params}`);
    
    if (response.ok) {
        const data = await response.json();
        this.discoveredChats = data.chats || [];
        
        // Update UI counters
        document.getElementById('lastScan').textContent = new Date().toLocaleTimeString();
        document.getElementById('groupsToday').textContent = this.discoveredChats.length;
        
        console.log(`‚úÖ Loaded ${this.discoveredChats.length} discovered chats`);
    } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
} catch (error) {
    console.error('‚ùå Failed to load discovered chats:', error);
    this.discoveredChats = this.getFallbackChats();
    this.systemHealth.discovery = false;
    this.updateSystemHealthUI();
}
}

getFallbackChats() {
return [
    {
        id: -1001234567890,
        title: "Tech Community",
        type: "supergroup",
        username: "techcomm",
        participants_count: 1250,
        is_public: true,
        discovered_at: new Date().toISOString()
    },
    {
        id: -1001234567891,
        title: "News Channel",
        type: "channel",
        username: "newschannel",
        participants_count: 5480,
        is_public: true,
        discovered_at: new Date().toISOString()
    }
];
}

async loadConfiguredGroups() {
try {
    console.log('‚öôÔ∏è Loading configured groups...');
    
    if (!this.systemHealth.replicator) {
        console.warn('‚ö†Ô∏è Message Replicator not available');
        this.configuredGroups = [];
        return;
    }

    const response = await fetch(this.API.replicator.groups);
    
    if (response.ok) {
        const data = await response.json();
        
        if (data.success && data.groups) {
            // Convert from object to array format
            this.configuredGroups = Object.entries(data.groups).map(([id, config]) => ({
                id: parseInt(id),
                title: config.group_name,
                type: "configured",
                is_configured: true,
                is_active: config.enabled,
                webhook_url: config.webhook_url,
                message_count: config.message_count || 0,
                last_activity: config.updated_at,
                filters: config.filters || {},
                transformations: config.transformations || {}
            }));
        } else {
            this.configuredGroups = [];
        }
        
        console.log(`‚úÖ Loaded ${this.configuredGroups.length} configured groups`);
    } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
} catch (error) {
    console.error('‚ùå Failed to load configured groups:', error);
    this.configuredGroups = [];
    this.systemHealth.replicator = false;
    this.updateSystemHealthUI();
}
}

renderDiscoveredChats() {
const container = document.getElementById('discoveredChats');
if (!container) return;

let chats = [...this.discoveredChats];

// Apply search filter
if (this.searchTerm) {
    chats = chats.filter(chat => 
        chat.title?.toLowerCase().includes(this.searchTerm) ||
        chat.username?.toLowerCase().includes(this.searchTerm)
    );
}

// Apply type filter
if (this.currentFilter) {
    chats = chats.filter(chat => chat.type === this.currentFilter);
}

// Filter out already configured chats
const configuredIds = new Set(this.configuredGroups.map(g => g.id));
chats = chats.filter(chat => !configuredIds.has(chat.id));

// Update count
document.getElementById('discoveredPanelCount').textContent = chats.length;

if (chats.length === 0) {
    container.innerHTML = this.getEmptyStateHTML('discovery');
    return;
}

// Render chats
container.innerHTML = chats.map(chat => this.createDiscoveredChatHTML(chat)).join('');

// Add animation
container.querySelectorAll('.chat-item').forEach((item, index) => {
    item.style.animationDelay = `${index * 50}ms`;
    item.classList.add('slide-in');
});
}

createDiscoveredChatHTML(chat) {
const avatar = this.getChatAvatar(chat);
const memberCount = this.formatMemberCount(chat.participants_count);
const chatType = this.formatChatType(chat.type);

return `
    <div class="chat-item" draggable="true" data-chat-id="${chat.id}">
        <div class="chat-avatar" style="${this.getChatAvatarStyle(chat)}">${avatar}</div>
        <div class="chat-info">
            <div class="chat-title" title="${chat.title || 'Unknown Chat'}">${chat.title || 'Unknown Chat'}</div>
            <div class="chat-meta">
                <div class="chat-meta-item">
                    <i class="fas fa-users"></i>
                    <span>${memberCount}</span>
                </div>
                <span class="chat-type ${chat.type}">${chatType}</span>
                ${chat.username ? `<div class="chat-meta-item"><i class="fas fa-at"></i><span>${chat.username}</span></div>` : ''}
            </div>
        </div>
        <div class="chat-actions">
            <button class="action-btn success" onclick="groupsHub.quickConfigureChat(${chat.id})" title="Quick Configure">
                <i class="fas fa-plus"></i>
            </button>
            <button class="action-btn" onclick="groupsHub.previewChat(${chat.id})" title="Preview">
                <i class="fas fa-eye"></i>
            </button>
        </div>
    </div>
`;
}

renderConfiguredGroups() {
const container = document.getElementById('configuredChats');
if (!container) return;

// Update count
document.getElementById('configuredPanelCount').textContent = this.configuredGroups.length;

if (this.configuredGroups.length === 0) {
    container.innerHTML = this.getEmptyStateHTML('configured');
    return;
}

container.innerHTML = this.configuredGroups.map(group => this.createConfiguredGroupHTML(group)).join('');
}

createConfiguredGroupHTML(group) {
const avatar = (group.title || 'Unknown').charAt(0).toUpperCase();
const statusClass = group.is_active ? 'active' : 'paused';

return `
    <div class="configured-item ${statusClass}">
        <div class="status-indicator ${group.is_active ? '' : 'paused'}"></div>
        <div class="chat-avatar">${avatar}</div>
        <div class="chat-info">
            <div class="chat-title">${group.title || 'Unknown Group'}</div>
            <div class="chat-meta">
                <div class="chat-meta-item">
                    <i class="fas fa-${group.is_active ? 'play' : 'pause'}"></i>
                    <span>${group.is_active ? 'Active' : 'Paused'}</span>
                </div>
                <div class="chat-meta-item">
                    <i class="fas fa-message"></i>
                    <span>${group.message_count || 0} msgs</span>
                </div>
                <div class="chat-meta-item">
                    <i class="fas fa-link"></i>
                    <span>Discord</span>
                </div>
            </div>
        </div>
        <div class="configured-actions">
            <button class="action-btn" onclick="groupsHub.editGroup(${group.id})" title="Edit Configuration">
                <i class="fas fa-cog"></i>
            </button>
            <button class="action-btn" onclick="groupsHub.toggleGroup(${group.id})" title="${group.is_active ? 'Pause' : 'Resume'}">
                <i class="fas fa-${group.is_active ? 'pause' : 'play'}"></i>
            </button>
            <button class="action-btn danger" onclick="groupsHub.removeGroup(${group.id})" title="Remove">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>
`;
}

getChatAvatar(chat) {
if (chat.title) {
    return chat.title.charAt(0).toUpperCase();
}

const typeIcons = {
    'channel': 'üì¢',
    'supergroup': 'üë•',
    'group': 'üí¨'
};

return typeIcons[chat.type] || '‚ùì';
}

getChatAvatarStyle(chat) {
const gradients = {
    'channel': 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
    'supergroup': 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
    'group': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
};

return `background: ${gradients[chat.type] || 'var(--primary-gradient)'}`;
}

formatMemberCount(count) {
if (!count || count <= 1) return 'Unknown';
if (count < 1000) return count.toString();
if (count < 1000000) return (count / 1000).toFixed(1) + 'K';
return (count / 1000000).toFixed(1) + 'M';
}

formatChatType(type) {
if (!type) return 'Unknown';
const typeMap = {
    'group': 'Group',
    'supergroup': 'Supergroup', 
    'channel': 'Channel'
};
return typeMap[type.toLowerCase()] || type;
}

getEmptyStateHTML(type) {
if (type === 'discovery') {
    if (!this.systemHealth.discovery) {
        return `
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Discovery Service Unavailable</h3>
                <p>The Discovery Service is not running. Please start it to discover groups automatically.</p>
            </div>
        `;
    }
    return `
        <div class="empty-state">
            <i class="fas fa-search"></i>
            <h3>No groups found</h3>
            <p>Try running a discovery scan or adjusting your filters</p>
        </div>
    `;
} else {
    return `
        <div class="empty-state">
            <i class="fas fa-plus-circle"></i>
            <h3>No groups configured yet</h3>
            <p>Drag groups from the left panel or use the quick configure button</p>
        </div>
    `;
}
}

updateUI() {
this.renderDiscoveredChats();
this.renderConfiguredGroups();
this.updateStats();
}

updateStats() {
document.getElementById('discoveredCount').textContent = this.discoveredChats.length;
document.getElementById('configuredCount').textContent = this.configuredGroups.length;
document.getElementById('activeCount').textContent = this.configuredGroups.filter(g => g.is_active).length;
}

// ============= ACTION METHODS =============

async quickConfigureChat(chatId) {
const chat = this.discoveredChats.find(c => c.id === chatId);
if (!chat) {
    this.showNotification('Chat not found', 'error');
    return;
}

if (!this.systemHealth.replicator) {
    this.showNotification('Message Replicator service is not available', 'error');
    return;
}

try {
    this.showNotification(`‚öôÔ∏è Configuring ${chat.title}...`, 'info');
    
    // Get available webhook (for now, use environment webhook)
    const webhook_url = "https://discord.com/api/webhooks/1399873931695100005/FByKlMB9JI_eUR-WXaRiFiP8pYdZbS7dCrpyPO66gK09DBnCeAvYBRv4--knBZU5HCBM";
    
    const config = {
        group_id: chatId,
        group_name: chat.title,
        webhook_url: webhook_url,
        enabled: true,
        filters: {
            exclude_bots: true,
            include_media: true,
            min_length: 1
        },
        transformations: {
            add_prefix: `[${chat.title}] `,
            watermark: false
        }
    };
    
    const response = await fetch(this.API.replicator.addGroup, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
    });
    
    if (response.ok) {
        const result = await response.json();
        
        if (result.success) {
            // Add to configured groups immediately for instant feedback
            this.configuredGroups.push({
                id: chatId,
                title: chat.title,
                type: "configured",
                is_configured: true,
                is_active: true,
                webhook_url: webhook_url,
                message_count: 0,
                last_activity: new Date().toISOString()
            });
            
            this.updateUI();
            this.showNotification(`‚úÖ ${chat.title} configured successfully!`, 'success');
            this.animateItemMove(chatId);
        } else {
            throw new Error(result.message || 'Configuration failed');
        }
    } else {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.detail || `HTTP ${response.status}`);
    }
} catch (error) {
    console.error('Quick configure error:', error);
    this.showNotification(`‚ùå Failed to configure ${chat.title}: ${error.message}`, 'error');
}
}

async toggleGroup(groupId) {
const group = this.configuredGroups.find(g => g.id === groupId);
if (!group) return;

try {
    const action = group.is_active ? 'disable' : 'enable';
    const response = await fetch(`http://localhost:8001/api/config/groups/${groupId}/${action}`, {
        method: 'POST'
    });
    
    if (response.ok) {
        const result = await response.json();
        if (result.success) {
            group.is_active = !group.is_active;
            this.updateUI();
            this.showNotification(`‚úÖ ${group.title} ${action}d successfully`, 'success');
        }
    } else {
        throw new Error(`Failed to ${action} group`);
    }
} catch (error) {
    console.error('Toggle group error:', error);
    this.showNotification(`‚ùå Failed to toggle ${group.title}`, 'error');
}
}

async removeGroup(groupId) {
const group = this.configuredGroups.find(g => g.id === groupId);
if (!group) return;

if (!confirm(`Are you sure you want to remove "${group.title}" from configuration?`)) {
    return;
}

try {
    const response = await fetch(`http://localhost:8001/api/config/groups/${groupId}`, {
        method: 'DELETE'
    });
    
    if (response.ok) {
        this.configuredGroups = this.configuredGroups.filter(g => g.id !== groupId);
        this.updateUI();
        this.showNotification(`‚úÖ ${group.title} removed successfully`, 'success');
    } else {
        throw new Error('Remove failed');
    }
} catch (error) {
    console.error('Remove group error:', error);
    this.showNotification(`‚ùå Failed to remove ${group.title}`, 'error');
}
}

editGroup(groupId) {
this.showNotification('Edit configuration feature coming soon!', 'info');
}

previewChat(chatId) {
this.showNotification('Chat preview feature coming soon!', 'info');
}

animateItemMove(chatId) {
const sourceItem = document.querySelector(`[data-chat-id="${chatId}"]`);
if (sourceItem) {
    sourceItem.style.transform = 'translateX(100%) scale(0.8)';
    sourceItem.style.opacity = '0';
    
    setTimeout(() => {
        this.updateUI();
    }, 300);
}
}

async startDiscoveryScan() {
if (!this.systemHealth.discovery) {
    this.showNotification('Discovery Service is not available', 'error');
    return;
}

try {
    this.showNotification('üîÑ Starting discovery scan...', 'info');
    
    const response = await fetch(this.API.discovery.scan, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ force_refresh: true, max_chats: 500 })
    });
    
    if (response.ok) {
        const result = await response.json();
        if (result.success) {
            this.showNotification('‚úÖ Discovery scan started successfully', 'success');
            
            // Refresh data after a delay
            setTimeout(async () => {
                await this.loadData();
                this.updateUI();
                this.showNotification('üéâ Discovery data refreshed', 'success');
            }, 5000);
        } else {
            throw new Error(result.message || 'Scan failed');
        }
    } else {
        throw new Error(`HTTP ${response.status}`);
    }
} catch (error) {
    console.error('Discovery scan error:', error);
    this.showNotification(`‚ùå Failed to start discovery scan: ${error.message}`, 'error');
}
}

async refreshAllData() {
this.showNotification('üîÑ Refreshing all data...', 'info');

try {
    await this.checkSystemHealth();
    await this.loadData();
    this.updateUI();
    this.showNotification('‚úÖ Data refreshed successfully', 'success');
} catch (error) {
    console.error('Refresh error:', error);
    this.showNotification('‚ùå Failed to refresh data', 'error');
}
}

startRealTimeUpdates() {
// Check system health periodically
setInterval(() => {
    this.checkSystemHealth();
}, 30000);

// Refresh data periodically if services are healthy
setInterval(async () => {
    if (this.systemHealth.discovery || this.systemHealth.replicator) {
        await this.loadData();
        this.updateUI();
    }
}, 60000);
}

showNotification(message, type = 'info') {
// Remove existing notifications
document.querySelectorAll('.notification').forEach(n => n.remove());

const notification = document.createElement('div');
notification.className = `notification ${type}`;

const iconMap = {
    'success': 'fas fa-check-circle',
    'error': 'fas fa-exclamation-circle',
    'warning': 'fas fa-exclamation-triangle',
    'info': 'fas fa-info-circle'
};

notification.innerHTML = `
    <i class="${iconMap[type] || iconMap.info}"></i>
    <span>${message}</span>
    <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
`;

document.body.appendChild(notification);

// Auto-remove after 5 seconds
setTimeout(() => {
    if (document.body.contains(notification)) {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }
}, 5000);
}
}

// ============= GLOBAL FUNCTIONS =============

function startDiscoveryScan() {
if (window.groupsHub) {
window.groupsHub.startDiscoveryScan();
}
}

function refreshAllData() {
if (window.groupsHub) {
window.groupsHub.refreshAllData();
}
}

// ============= INITIALIZATION =============

document.addEventListener('DOMContentLoaded', () => {
try {
console.log('üé≠ Starting Enterprise Groups Hub...');
window.groupsHub = new EnterpriseGroupsHub();
} catch (error) {
console.error('‚ùå Failed to initialize Groups Hub:', error);

// Show error page
document.body.innerHTML = `
    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; color: white; text-align: center; padding: 2rem;">
        <div style="background: var(--bg-card); padding: 3rem; border-radius: 20px; border: 1px solid var(--border-glass); backdrop-filter: blur(20px); max-width: 600px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #f59e0b; margin-bottom: 2rem;"></i>
            <h1 style="margin-bottom: 1rem; font-size: 2rem;">Groups Hub Failed to Initialize</h1>
            <p style="color: var(--text-secondary); margin-bottom: 2rem; line-height: 1.6; font-size: 1.1rem;">
                The Groups Hub could not start properly. This usually happens when:<br><br>
                ‚Ä¢ <strong>Discovery Service</strong> is not running on port 8002<br>
                ‚Ä¢ <strong>Message Replicator</strong> is not running on port 8001<br>
                ‚Ä¢ Network connectivity issues<br>
                ‚Ä¢ Browser compatibility problems
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 2rem;">
                <button onclick="location.reload()" style="padding: 1rem 2rem; background: #3b82f6; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                    <i class="fas fa-refresh"></i> Retry
                </button>
                <button onclick="window.open('/health', '_blank')" style="padding: 1rem 2rem; background: var(--bg-glass); color: white; border: 1px solid var(--border-glass); border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                    <i class="fas fa-stethoscope"></i> Check System Health
                </button>
                <button onclick="window.open('/dashboard', '_blank')" style="padding: 1rem 2rem; background: var(--success-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                    <i class="fas fa-tachometer-alt"></i> Main Dashboard
                </button>
            </div>
            <div style="background: rgba(0, 0, 0, 0.3); padding: 1.5rem; border-radius: 12px; font-family: monospace; text-align: left;">
                <strong>Quick Diagnosis:</strong><br>
                1. Check if all services are running<br>
                2. Verify .env configuration<br>
                3. Check browser console (F12) for errors<br>
                4. Ensure port 8000, 8001, 8002 are available
            </div>
            <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 2rem;">
                Need help? Check the system documentation or contact support.<br>
                Error details are available in the browser console (F12).
            </p>
        </div>
    </div>
`;
}
});

// Global error handler
window.addEventListener('error', (event) => {
console.error('Global error:', event.error);
if (window.groupsHub) {
window.groupsHub.showNotification('An unexpected error occurred. Please refresh the page.', 'error');
}
});

// Enhanced network monitoring
window.addEventListener('online', () => {
if (window.groupsHub) {
window.groupsHub.showNotification('üåê Connection restored', 'success');
setTimeout(() => {
    window.groupsHub.checkSystemHealth();
    window.groupsHub.loadData();
}, 1000);
}
});

window.addEventListener('offline', () => {
if (window.groupsHub) {
window.groupsHub.showNotification('üì° Connection lost - working offline', 'warning');
}
});

// Performance monitoring
window.addEventListener('load', () => {
const loadTime = performance.now();
console.log(`üöÄ Groups Hub loaded in ${loadTime.toFixed(2)}ms`);
});

// Debug helpers for development
if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
window.groupsHubDebug = {
reload: () => location.reload(),
clearCache: () => {
    localStorage.clear();
    sessionStorage.clear();
    location.reload();
},
testNotification: (type = 'info') => {
    if (window.groupsHub) {
        window.groupsHub.showNotification(`Test ${type} notification`, type);
    }
},
showStats: () => {
    if (window.groupsHub) {
        console.table({
            'Discovered Chats': window.groupsHub.discoveredChats.length,
            'Configured Groups': window.groupsHub.configuredGroups.length,
            'Active Groups': window.groupsHub.configuredGroups.filter(g => g.is_active).length,
            'Discovery Service': window.groupsHub.systemHealth.discovery ? 'Online' : 'Offline',
            'Replicator Service': window.groupsHub.systemHealth.replicator ? 'Online' : 'Offline',
            'Current Filter': window.groupsHub.currentFilter || 'None',
            'Search Term': window.groupsHub.searchTerm || 'None'
        });
    }
},
forceRefresh: () => {
    if (window.groupsHub) {
        window.groupsHub.loadData().then(() => {
            window.groupsHub.updateUI();
            console.log('‚úÖ Forced refresh completed');
        });
    }
},
testServices: async () => {
    if (window.groupsHub) {
        await window.groupsHub.checkSystemHealth();
        console.log('System Health:', window.groupsHub.systemHealth);
    }
}
};

console.log('üõ†Ô∏è Debug helpers available:');
console.log('  groupsHubDebug.reload() - Reload page');
console.log('  groupsHubDebug.clearCache() - Clear cache and reload');
console.log('  groupsHubDebug.testNotification(type) - Test notifications');
console.log('  groupsHubDebug.showStats() - Show current stats');
console.log('  groupsHubDebug.forceRefresh() - Force data refresh');
console.log('  groupsHubDebug.testServices() - Test service connectivity');
}

// Memory cleanup on page unload
window.addEventListener('beforeunload', () => {
if (window.groupsHub) {
// Clear any intervals or timeouts
console.log('üßπ Cleaning up Groups Hub...');
}
});

console.log('üé≠ Groups Hub Enterprise - Fully Loaded');
console.log('üìã Features enabled:');
console.log('  ‚úÖ Auto-discovery integration');
console.log('  ‚úÖ Real-time configuration');
console.log('  ‚úÖ Enhanced drag & drop');
console.log('  ‚úÖ System health monitoring');
console.log('  ‚úÖ Error boundary handling');
console.log('  ‚úÖ Network status monitoring');
console.log('  ‚úÖ Smart fallback systems');
</script>
</body>
</html>
            <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé≠ Groups Hub - Enterprise Management</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
--primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
--success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
--warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
--danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
--bg-glass: rgba(255, 255, 255, 0.05);
--bg-glass-hover: rgba(255, 255, 255, 0.1);
--bg-card: rgba(255, 255, 255, 0.08);
--border-glass: rgba(255, 255, 255, 0.1);
--text-primary: rgba(255, 255, 255, 0.95);
--text-secondary: rgba(255, 255, 255, 0.7);
--text-muted: rgba(255, 255, 255, 0.5);
--shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
min-height: 100vh;
color: var(--text-primary);
overflow-x: hidden;
}

.container {
max-width: 1600px;
margin: 0 auto;
padding: 1.5rem;
}

/* ============= HEADER ENTERPRISE ============= */
.main-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 2rem;
padding: 2rem;
background: var(--bg-card);
backdrop-filter: blur(20px);
border-radius: 20px;
border: 1px solid var(--border-glass);
box-shadow: var(--shadow-xl);
position: relative;
overflow: hidden;
}

.main-header::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
background: var(--primary-gradient);
}

.header-title {
display: flex;
align-items: center;
gap: 1rem;
}

.header-title h1 {
font-size: 2.2rem;
font-weight: 800;
background: var(--primary-gradient);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.header-stats {
display: flex;
gap: 2rem;
align-items: center;
}

.stat-item {
text-align: center;
position: relative;
}

.stat-item::after {
content: '';
position: absolute;
bottom: -0.5rem;
left: 50%;
transform: translateX(-50%);
width: 30px;
height: 2px;
background: var(--success-gradient);
border-radius: 2px;
}

.stat-value {
font-size: 2rem;
font-weight: 700;
color: var(--text-primary);
display: block;
}

.stat-label {
font-size: 0.8rem;
color: var(--text-muted);
text-transform: uppercase;
letter-spacing: 0.5px;
}

.quick-actions {
display: flex;
gap: 1rem;
}

.btn {
padding: 1rem 2rem;
border: none;
border-radius: 16px;
font-size: 1rem;
font-weight: 600;
cursor: pointer;
transition: var(--transition);
display: flex;
align-items: center;
gap: 0.5rem;
text-decoration: none;
color: var(--text-primary);
position: relative;
overflow: hidden;
}

.btn::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
transition: left 0.5s;
}

.btn:hover::before {
left: 100%;
}

.btn-primary {
background: var(--primary-gradient);
box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
}

.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
}

.btn-success {
background: var(--success-gradient);
box-shadow: 0 8px 32px rgba(79, 172, 254, 0.3);
}

.btn-success:hover {
transform: translateY(-2px);
box-shadow: 0 12px 40px rgba(79, 172, 254, 0.4);
}

/* ============= ENHANCED METRICS BAR ============= */
.metrics-bar {
background: var(--bg-card);
backdrop-filter: blur(20px);
border-radius: 20px;
border: 1px solid var(--border-glass);
padding: 1.5rem 2rem;
margin-bottom: 2rem;
display: flex;
justify-content: space-between;
align-items: center;
position: relative;
}

.metrics-bar::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 2px;
background: var(--success-gradient);
}

.metric-group {
display: flex;
gap: 2rem;
}

.metric-item {
display: flex;
align-items: center;
gap: 0.75rem;
padding: 0.5rem 1rem;
background: var(--bg-glass);
border-radius: 12px;
transition: var(--transition);
}

.metric-item:hover {
background: var(--bg-glass-hover);
transform: translateY(-1px);
}

.metric-icon {
width: 20px;
height: 20px;
border-radius: 50%;
background: #10b981;
position: relative;
}

.metric-icon::after {
content: '';
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
width: 8px;
height: 8px;
background: rgba(255,255,255,0.8);
border-radius: 50%;
}

.metric-icon.warning {
background: #f59e0b;
}

.metric-icon.error {
background: #ef4444;
}

.metric-text {
font-size: 0.9rem;
color: var(--text-secondary);
font-weight: 500;
}

/* ============= MAIN LAYOUT FIXED ============= */
.main-layout {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 2rem;
margin-bottom: 2rem;
}

.panel {
background: var(--bg-card);
backdrop-filter: blur(20px);
border-radius: 20px;
border: 1px solid var(--border-glass);
padding: 2rem;
box-shadow: var(--shadow-xl);
position: relative;
overflow: hidden;
}

.panel::before {
content: '';
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 3px;
background: var(--primary-gradient);
}

.panel-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 2rem;
padding-bottom: 1rem;
border-bottom: 1px solid var(--border-glass);
}

.panel-title {
font-size: 1.3rem;
font-weight: 700;
color: var(--text-primary);
display: flex;
align-items: center;
gap: 0.75rem;
}

.panel-title i {
font-size: 1.1rem;
color: #667eea;
}

.panel-count {
background: var(--bg-glass);
padding: 0.25rem 0.75rem;
border-radius: 20px;
font-size: 0.8rem;
font-weight: 600;
border: 1px solid var(--border-glass);
}

/* ============= DISCOVERY CONTROLS ============= */
.discovery-controls {
display: flex;
gap: 1rem;
margin-bottom: 1.5rem;
flex-wrap: wrap;
}

.search-container {
flex: 1;
position: relative;
min-width: 200px;
}

.search-input {
width: 100%;
padding: 0.75rem 1rem 0.75rem 2.5rem;
background: var(--bg-glass);
border: 1px solid var(--border-glass);
border-radius: 12px;
color: var(--text-primary);
font-size: 0.9rem;
transition: var(--transition);
}

.search-input:focus {
outline: none;
border-color: #3b82f6;
background: var(--bg-glass-hover);
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.search-icon {
position: absolute;
left: 0.75rem;
top: 50%;
transform: translateY(-50%);
color: var(--text-muted);
pointer-events: none;
}

.filter-group {
display: flex;
gap: 0.5rem;
flex-wrap: wrap;
}

.filter-btn {
padding: 0.75rem 1rem;
background: var(--bg-glass);
border: 1px solid var(--border-glass);
border-radius: 12px;
color: var(--text-secondary);
font-size: 0.8rem;
cursor: pointer;
transition: var(--transition);
font-weight: 500;
white-space: nowrap;
}

.filter-btn:hover {
background: var(--bg-glass-hover);
border-color: #3b82f6;
}

.filter-btn.active {
background: #3b82f6;
color: white;
border-color: #3b82f6;
box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
}

/* ============= CHAT LISTS FIXED ============= */
.chat-list {
max-height: 600px;
overflow-y: auto;
scrollbar-width: thin;
scrollbar-color: var(--border-glass) transparent;
}

.chat-list::-webkit-scrollbar {
width: 6px;
}

.chat-list::-webkit-scrollbar-track {
background: transparent;
}

.chat-list::-webkit-scrollbar-thumb {
background: var(--border-glass);
border-radius: 3px;
}

.chat-item {
display: flex;
align-items: center;
gap: 1rem;
padding: 1rem;
margin-bottom: 0.5rem;
background: var(--bg-glass);
border: 1px solid var(--border-glass);
border-radius: 12px;
cursor: pointer;
transition: var(--transition);
position: relative;
overflow: hidden;
}

.chat-item::before {
content: '';
position: absolute;
left: 0;
top: 0;
bottom: 0;
width: 4px;
background: var(--primary-gradient);
opacity: 0;
transition: var(--transition);
}

.chat-item:hover {
background: var(--bg-glass-hover);
border-color: #3b82f6;
transform: translateY(-1px);
box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.chat-item:hover::before {
opacity: 1;
}

.chat-item.dragging {
opacity: 0.7;
transform: rotate(2deg) scale(0.95);
z-index: 1000;
}

.chat-avatar {
width: 48px;
height: 48px;
border-radius: 12px;
background: var(--primary-gradient);
display: flex;
align-items: center;
justify-content: center;
font-size: 1.2rem;
font-weight: 700;
color: white;
flex-shrink: 0;
position: relative;
overflow: hidden;
}

.chat-info {
flex: 1;
min-width: 0;
}

.chat-title {
font-size: 0.95rem;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 0.25rem;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

.chat-meta {
display: flex;
gap: 1rem;
font-size: 0.75rem;
color: var(--text-muted);
flex-wrap: wrap;
}

.chat-meta-item {
display: flex;
align-items: center;
gap: 0.25rem;
}

.chat-type {
padding: 0.2rem 0.6rem;
border-radius: 8px;
font-size: 0.7rem;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.5px;
}

.chat-type.channel {
background: rgba(139, 92, 246, 0.2);
color: #8b5cf6;
border: 1px solid rgba(139, 92, 246, 0.3);
}

.chat-type.group, .chat-type.supergroup, .chat-type.megagroup {
background: rgba(16, 185, 129, 0.2);
color: #10b981;
border: 1px solid rgba(16, 185, 129, 0.3);
}

.chat-actions {
display: flex;
gap: 0.5rem;
opacity: 0;
transition: var(--transition);
}

.chat-item:hover .chat-actions {
opacity: 1;
}

.action-btn {
width: 32px;
height: 32px;
border: none;
background: var(--bg-glass);
color: var(--text-secondary);
border-radius: 8px;
cursor: pointer;
transition: var(--transition);
display: flex;
align-items: center;
justify-content: center;
border: 1px solid var(--border-glass);
}

.action-btn:hover {
background: #3b82f6;
color: white;
transform: scale(1.1);
box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.action-btn.success:hover {
background: #10b981;
box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.action-btn.danger:hover {
background: #ef4444;
box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
}

/* ============= DROP ZONE ============= */
.drop-zone {
min-height: 120px;
border: 2px dashed var(--border-glass);
border-radius: 16px;
display: flex;
align-items: center;
justify-content: center;
margin-bottom: 1rem;
transition: var(--transition);
opacity: 0;
background: var(--bg-glass);
position: relative;
overflow: hidden;
}

.drop-zone.active {
opacity: 1;
border-color: #10b981;
background: rgba(16, 185, 129, 0.1);
transform: scale(1.02);
}

.drop-message {
color: var(--text-muted);
font-size: 0.9rem;
text-align: center;
padding: 1rem;
}

.drop-message i {
font-size: 2rem;
margin-bottom: 1rem;
display: block;
color: #10b981;
}

/* ============= CONFIGURED ITEMS ============= */
.configured-item {
display: flex;
align-items: center;
gap: 1rem;
padding: 1rem;
margin-bottom: 0.5rem;
background: var(--bg-glass);
border: 1px solid var(--border-glass);
border-radius: 12px;
transition: var(--transition);
position: relative;
}

.configured-item::before {
content: '';
position: absolute;
left: 0;
top: 0;
bottom: 0;
width: 4px;
background: #10b981;
border-radius: 0 4px 4px 0;
}

.configured-item.active {
border-color: #10b981;
background: rgba(16, 185, 129, 0.1);
}

.configured-item.error::before {
background: #ef4444;
}

.configured-item.error {
border-color: #ef4444;
background: rgba(239, 68, 68, 0.1);
}

.status-indicator {
position: absolute;
top: 0.5rem;
right: 0.5rem;
width: 12px;
height: 12px;
border-radius: 50%;
background: #10b981;
border: 2px solid rgba(255,255,255,0.2);
}

.status-indicator.paused {
background: #f59e0b;
}

.status-indicator.error {
background: #ef4444;
}

.configured-actions {
display: flex;
gap: 0.5rem;
}

.configured-actions .action-btn {
opacity: 1;
}

/* ============= EMPTY & LOADING STATES ============= */
.empty-state {
text-align: center;
padding: 3rem 2rem;
color: var(--text-muted);
}

.empty-state i {
font-size: 3rem;
margin-bottom: 1rem;
display: block;
opacity: 0.5;
}

.empty-state h3 {
color: var(--text-secondary);
margin-bottom: 0.5rem;
font-weight: 600;
}

.empty-state p {
font-size: 0.9rem;
line-height: 1.5;
}

.loading-state {
text-align: center;
padding: 3rem 2rem;
color: var(--text-secondary);
}

.loading-spinner {
font-size: 2rem;
margin-bottom: 1rem;
display: block;
animation: spin 1s linear infinite;
color: #3b82f6;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* ============= NOTIFICATIONS ============= */
.notification {
position: fixed;
top: 20px;
right: 20px;
padding: 1rem 1.5rem;
border-radius: 12px;
color: white;
font-weight: 600;
z-index: 1001;
max-width: 400px;
box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
backdrop-filter: blur(20px);
border: 1px solid rgba(255,255,255,0.1);
animation: slideInRight 0.3s ease-out;
display: flex;
align-items: center;
gap: 0.75rem;
}

.notification.success {
background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.notification.error {
background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.notification.warning {
background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.notification.info {
background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.notification-close {
background: none;
border: none;
color: white;
cursor: pointer;
font-size: 1.2rem;
opacity: 0.8;
margin-left: auto;
}

.notification-close:hover {
opacity: 1;
}

@keyframes slideInRight {
from { opacity: 0; transform: translateX(100%); }
to { opacity: 1; transform: translateX(0); }
}

/* ============= RESPONSIVE ============= */
@media (max-width: 1024px) {
.main-layout {
grid-template-columns: 1fr;
}

.header-stats {
flex-direction: column;
gap: 1rem;
}

.metric-group {
flex-direction: column;
gap: 0.5rem;
}

.discovery-controls {
flex-direction: column;
}
}

@media (max-width: 768px) {
.container {
padding: 1rem;
}

.main-header {
flex-direction: column;
gap: 1rem;
text-align: center;
}

.quick-actions {
flex-direction: column;
width: 100%;
}

.chat-actions {
opacity: 1;
}
}

/* ============= ANIMATIONS ============= */
.slide-in {
animation: slideIn 0.5s ease-out;
}

@keyframes slideIn {
from {
opacity: 0;
transform: translateY(20px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

/* ============= SYSTEM STATUS ============= */
.system-status {
position: fixed;
bottom: 20px;
left: 20px;
background: var(--bg-card);
backdrop-filter: blur(20px);
border: 1px solid var(--border-glass);
border-radius: 12px;
padding: 1rem;
font-size: 0.8rem;
z-index: 1000;
display: flex;
align-items: center;
gap: 0.5rem;
}

.system-status.online {
border-left: 4px solid #10b981;
}

.system-status.offline {
border-left: 4px solid #ef4444;
}
</style>
</head>
<body>
<div class="container">
<!-- Enhanced Header -->
<header class="main-header slide-in">
<div class="header-title">
<h1>üé≠ Groups Hub</h1>
<div class="header-stats">
    <div class="stat-item">
        <span class="stat-value" id="discoveredCount">0</span>
        <span class="stat-label">Discovered</span>
    </div>
    <div class="stat-item">
        <span class="stat-value" id="configuredCount">0</span>
        <span class="stat-label">Configured</span>
    </div>
    <div class="stat-item">
        <span class="stat-value" id="activeCount">0</span>
        <span class="stat-label">Active</span>
    </div>
</div>
</div>
<div class="quick-actions">
<button class="btn btn-success" onclick="startDiscoveryScan()">
    <i class="fas fa-search"></i>
    Discover Groups
</button>
<button class="btn btn-primary" onclick="refreshAllData()">
    <i class="fas fa-sync"></i>
    Refresh Data
</button>
<a href="/dashboard" class="btn" style="background: var(--bg-glass);">
    <i class="fas fa-arrow-left"></i>
    Dashboard
</a>
</div>
</header>

<!-- Enhanced Performance Metrics -->
<div class="metrics-bar slide-in">
<div class="metric-group">
<div class="metric-item">
    <div class="metric-icon" id="discoveryServiceStatus"></div>
    <span class="metric-text">Discovery Service</span>
</div>
<div class="metric-item">
    <div class="metric-icon" id="replicatorServiceStatus"></div>
    <span class="metric-text">Message Replicator</span>
</div>
<div class="metric-item">
    <div class="metric-icon" id="systemStatus"></div>
    <span class="metric-text">System Online</span>
</div>
</div>
<div class="metric-group">
<div class="metric-item">
    <span class="metric-text">Last scan: <strong id="lastScan">Never</strong></span>
</div>
<div class="metric-item">
    <span class="metric-text">Groups found: <strong id="groupsToday">0</strong></span>
</div>
</div>
</div>

<!-- Main Layout -->
<div class="main-layout">
<!-- Discovery Panel Enhanced -->
<div class="panel discovery-panel slide-in">
<div class="panel-header">
    <div class="panel-title">
        <i class="fas fa-search"></i>
        Discovered Groups & Channels
        <span class="panel-count" id="discoveredPanelCount">0</span>
    </div>
</div>

<div class="discovery-controls">
    <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-input" placeholder="Search groups and channels..." id="discoverySearch">
    </div>
    <div class="filter-group">
        <button class="filter-btn active" data-filter="">All Types</button>
        <button class="filter-btn" data-filter="channel">Channels</button>
        <button class="filter-btn" data-filter="supergroup">Supergroups</button>
        <button class="filter-btn" data-filter="group">Groups</button>
    </div>
</div>

<div class="chat-list" id="discoveredChats">
    <div class="loading-state">
        <i class="fas fa-spinner loading-spinner"></i>
        <h3>Loading discovered groups...</h3>
        <p>Connecting to Discovery Service...</p>
    </div>
</div>
</div>

<!-- Configured Panel Enhanced -->
<div class="panel configured-panel slide-in">
    <div class="panel-header">
        <div class="panel-title">
            <i class="fas fa-cogs"></i>
            Configured Groups
            <span class="panel-count" id="configuredPanelCount">0</span>
        </div>
    </div>

    <div class="drop-zone" id="dropZone">
        <div class="drop-message">
            <i class="fas fa-hand-point-right"></i>
            <strong>Drag groups here to configure</strong><br>
            Auto-setup with smart defaults
        </div>
    </div>

    <div class="chat-list" id="configuredChats">
        <div class="empty-state">
            <i class="fas fa-plus-circle"></i>
            <h3>No groups configured yet</h3>
            <p>Start by discovering groups or drag them here to configure</p>
        </div>
    </div>
</div>
</div>
</div>

<!-- System Status Indicator -->
<div class="system-status online" id="systemStatusIndicator">
<i class="fas fa-circle" style="color: #10b981;"></i>
<span>System Online</span>
</div>

<script>
// ============= ENHANCED GROUPS HUB APPLICATION =============
class EnterpriseGroupsHub {
constructor() {
    this.discoveredChats = [];
    this.configuredGroups = [];
    this.draggedItem = null;
    this.searchTerm = '';
    this.currentFilter = '';
    this.isLoading = false;
    this.systemHealth = {
        discovery: false,
        replicator: false,
        orchestrator: true
    };

    // API endpoints
    this.API = {
        discovery: {
            chats: '/api/discovery/chats',
            scan: '/api/discovery/scan',
            status: '/api/discovery/status'
        },
        replicator: {
            groups: '/api/config/groups',
            addGroup: '/api/config/add_group',
            health: 'http://localhost:8001/health'
        },
        groups: {
            all: '/api/groups/all',
            configure: '/api/groups/configure'
        }
    };

    this.init();
}

async init() {
    console.log('üé≠ Initializing Enterprise Groups Hub...');
    
    try {
        await this.checkSystemHealth();
        await this.loadData();
        this.setupEventListeners();
        this.setupDragAndDrop();
        this.updateUI();
        this.startRealTimeUpdates();
        
        console.log('‚úÖ Enterprise Groups Hub ready');
    } catch (error) {
        console.error('‚ùå Failed to initialize Groups Hub:', error);
        this.showNotification('Failed to initialize Groups Hub', 'error');
    }
}

async checkSystemHealth() {
    console.log('üîç Checking system health...');
    
    // Check Discovery Service
    try {
        const discoveryResponse = await fetch('/api/discovery/chats?limit=1');
        this.systemHealth.discovery = discoveryResponse.ok;
    } catch {
        this.systemHealth.discovery = false;
    }

    // Check Message Replicator
    try {
        const replicatorResponse = await fetch('http://localhost:8001/health');
        this.systemHealth.replicator = replicatorResponse.ok;
    } catch {
        this.systemHealth.replicator = false;
    }

    this.updateSystemHealthUI();
}

updateSystemHealthUI() {
    const discoveryIcon = document.getElementById('discoveryServiceStatus');
    const replicatorIcon = document.getElementById('replicatorServiceStatus');
    const systemIcon = document.getElementById('systemStatus');
    const systemIndicator = document.getElementById('systemStatusIndicator');

    // Update discovery service status
    if (this.systemHealth.discovery) {
        discoveryIcon.className = 'metric-icon';
    } else {
        discoveryIcon.className = 'metric-icon error';
    }

    // Update replicator service status
    if (this.systemHealth.replicator) {
        replicatorIcon.className = 'metric-icon';
    } else {
        replicatorIcon.className = 'metric-icon error';
    }

    // Update overall system status
    const allHealthy = this.systemHealth.discovery && this.systemHealth.replicator;
    if (allHealthy) {
        systemIcon.className = 'metric-icon';
        systemIndicator.className = 'system-status online';
        systemIndicator.innerHTML = '<i class="fas fa-circle" style="color: #10b981;"></i><span>System Online</span>';
    } else {
        systemIcon.className = 'metric-icon warning';
        systemIndicator.className = 'system-status offline';
        systemIndicator.innerHTML = '<i class="fas fa-circle" style="color: #ef4444;"></i><span>Service Issues</span>';
    }
}

setupEventListeners() {
    // Enhanced search with debouncing
    let searchTimeout;
    const searchInput = document.getElementById('discoverySearch');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                this.searchTerm = e.target.value.toLowerCase().trim();
                this.renderDiscoveredChats();
            }, 300);
        });
    }

    // Enhanced filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            this.currentFilter = e.target.dataset.filter;
            this.renderDiscoveredChats();
        });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            searchInput?.focus();
        }
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            this.refreshAllData();
        }
    });
}

setupDragAndDrop() {
    const dropZone = document.getElementById('dropZone');
    if (!dropZone) return;

    // Enhanced drag start
    document.addEventListener('dragstart', (e) => {
        if (e.target.closest('.chat-item')) {
            this.draggedItem = e.target.closest('.chat-item');
            dropZone.classList.add('active');
            e.target.closest('.chat-item').classList.add('dragging');
            
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.closest('.chat-item').outerHTML);
        }
    });

    document.addEventListener('dragend', (e) => {
        dropZone.classList.remove('active');
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('dragging');
        });
        this.draggedItem = null;
    });

    // Enhanced drop functionality
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    });

    dropZone.addEventListener('drop', async (e) => {
        e.preventDefault();
        if (this.draggedItem) {
            const chatId = parseInt(this.draggedItem.dataset.chatId);
            await this.quickConfigureChat(chatId);
        }
    });
}

async loadData() {
    if (this.isLoading) return;
    this.isLoading = true;

    try {
        console.log('üì° Loading data from services...');
        
        await Promise.all([
            this.loadDiscoveredChats(),
            this.loadConfiguredGroups()
        ]);
        
    } catch (error) {
        console.error('‚ùå Error loading data:', error);
        this.showNotification('Failed to load data. Check service connectivity.', 'error');
    } finally {
        this.isLoading = false;
    }
}

async loadDiscoveredChats() {
    try {
        console.log('üîç Loading discovered chats...');
        
        if (!this.systemHealth.discovery) {
            console.warn('‚ö†Ô∏è Discovery Service not available - using fallback');
            this.discoveredChats = this.getFallbackChats();
            return;
        }

        const params = new URLSearchParams({
            limit: '100',
            chat_type: 'group,supergroup,channel',
            is_private: 'false'
        });
        
        const response = await fetch(`${this.API.discovery.chats}?${params}`);
        
        if (response.ok) {
            const data = await response.json();
            this.discoveredChats = data.chats || [];
            
            // Update UI counters
            document.getElementById('lastScan').textContent = new Date().toLocaleTimeString();
            document.getElementById('groupsToday').textContent = this.discoveredChats.length;
            
            console.log(`‚úÖ Loaded ${this.discoveredChats.length} discovered chats`);
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('‚ùå Failed to load discovered chats:', error);
        this.discoveredChats = this.getFallbackChats();
        this.systemHealth.discovery = false;
        this.updateSystemHealthUI();
    }
}

getFallbackChats() {
    return [
        {
            id: -1001234567890,
            title: "Tech Community",
            type: "supergroup",
            username: "techcomm",
            participants_count: 1250,
            is_public: true,
            discovered_at: new Date().toISOString()
        },
        {
            id: -1001234567891,
            title: "News Channel",
            type: "channel",
            username: "newschannel",
            participants_count: 5480,
            is_public: true,
            discovered_at: new Date().toISOString()
        },
        {
            id: -1001234567892,
            title: "Development Group",
            type: "group",
            username: "devgroup",
            participants_count: 842,
            is_public: true,
            discovered_at: new Date().toISOString()
        }
    ];
}

async loadConfiguredGroups() {
    try {
        console.log('‚öôÔ∏è Loading configured groups...');
        
        if (!this.systemHealth.replicator) {
            console.warn('‚ö†Ô∏è Message Replicator not available');
            this.configuredGroups = [];
            return;
        }

        const response = await fetch(this.API.replicator.groups);
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.success && data.groups) {
                // Convert from object to array format
                this.configuredGroups = Object.entries(data.groups).map(([id, config]) => ({
                    id: parseInt(id),
                    title: config.group_name,
                    type: "configured",
                    is_configured: true,
                    is_active: config.enabled,
                    webhook_url: config.webhook_url,
                    message_count: config.message_count || 0,
                    last_activity: config.updated_at,
                    filters: config.filters || {},
                    transformations: config.transformations || {}
                }));
            } else {
                this.configuredGroups = [];
            }
            
            console.log(`‚úÖ Loaded ${this.configuredGroups.length} configured groups`);
        } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
    } catch (error) {
        console.error('‚ùå Failed to load configured groups:', error);
        this.configuredGroups = [];
        this.systemHealth.replicator = false;
        this.updateSystemHealthUI();
    }
}

renderDiscoveredChats() {
    const container = document.getElementById('discoveredChats');
    if (!container) return;

    let chats = [...this.discoveredChats];

    // Apply search filter
    if (this.searchTerm) {
        chats = chats.filter(chat => 
            chat.title?.toLowerCase().includes(this.searchTerm) ||
            chat.username?.toLowerCase().includes(this.searchTerm)
        );
    }

    // Apply type filter
    if (this.currentFilter) {
        chats = chats.filter(chat => chat.type === this.currentFilter);
    }

    // Filter out already configured chats
    const configuredIds = new Set(this.configuredGroups.map(g => g.id));
    chats = chats.filter(chat => !configuredIds.has(chat.id));

    // Update count
    document.getElementById('discoveredPanelCount').textContent = chats.length;

    if (chats.length === 0) {
        container.innerHTML = this.getEmptyStateHTML('discovery');
        return;
    }

    // Render chats
    container.innerHTML = chats.map(chat => this.createDiscoveredChatHTML(chat)).join('');

    // Add animation
    container.querySelectorAll('.chat-item').forEach((item, index) => {
        item.style.animationDelay = `${index * 50}ms`;
        item.classList.add('slide-in');
    });
}

createDiscoveredChatHTML(chat) {
    const avatar = this.getChatAvatar(chat);
    const memberCount = this.formatMemberCount(chat.participants_count);
    const chatType = this.formatChatType(chat.type);

    return `
        <div class="chat-item" draggable="true" data-chat-id="${chat.id}">
            <div class="chat-avatar" style="${this.getChatAvatarStyle(chat)}">${avatar}</div>
            <div class="chat-info">
                <div class="chat-title" title="${chat.title || 'Unknown Chat'}">${chat.title || 'Unknown Chat'}</div>
                <div class="chat-meta">
                    <div class="chat-meta-item">
                        <i class="fas fa-users"></i>
                        <span>${memberCount}</span>
                    </div>
                    <span class="chat-type ${chat.type}">${chatType}</span>
                    ${chat.username ? `<div class="chat-meta-item"><i class="fas fa-at"></i><span>${chat.username}</span></div>` : ''}
                </div>
            </div>
            <div class="chat-actions">
                <button class="action-btn success" onclick="groupsHub.quickConfigureChat(${chat.id})" title="Quick Configure">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="action-btn" onclick="groupsHub.previewChat(${chat.id})" title="Preview">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </div>
    `;
}

renderConfiguredGroups() {
    const container = document.getElementById('configuredChats');
    if (!container) return;

    // Update count
    document.getElementById('configuredPanelCount').textContent = this.configuredGroups.length;

    if (this.configuredGroups.length === 0) {
        container.innerHTML = this.getEmptyStateHTML('configured');
        return;
    }

    container.innerHTML = this.configuredGroups.map(group => this.createConfiguredGroupHTML(group)).join('');
}

createConfiguredGroupHTML(group) {
    const avatar = (group.title || 'Unknown').charAt(0).toUpperCase();
    const statusClass = group.is_active ? 'active' : 'paused';

    return `
        <div class="configured-item ${statusClass}">
            <div class="status-indicator ${group.is_active ? '' : 'paused'}"></div>
            <div class="chat-avatar">${avatar}</div>
            <div class="chat-info">
                <div class="chat-title">${group.title || 'Unknown Group'}</div>
                <div class="chat-meta">
                    <div class="chat-meta-item">
                        <i class="fas fa-${group.is_active ? 'play' : 'pause'}"></i>
                        <span>${group.is_active ? 'Active' : 'Paused'}</span>
                    </div>
                    <div class="chat-meta-item">
                        <i class="fas fa-message"></i>
                        <span>${group.message_count || 0} msgs</span>
                    </div>
                    <div class="chat-meta-item">
                        <i class="fas fa-link"></i>
                        <span>Discord</span>
                    </div>
                </div>
            </div>
            <div class="configured-actions">
                <button class="action-btn" onclick="groupsHub.editGroup(${group.id})" title="Edit Configuration">
                    <i class="fas fa-cog"></i>
                </button>
                <button class="action-btn" onclick="groupsHub.toggleGroup(${group.id})" title="${group.is_active ? 'Pause' : 'Resume'}">
                    <i class="fas fa-${group.is_active ? 'pause' : 'play'}"></i>
                </button>
                <button class="action-btn danger" onclick="groupsHub.removeGroup(${group.id})" title="Remove">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
}

getChatAvatar(chat) {
    if (chat.title) {
        return chat.title.charAt(0).toUpperCase();
    }

    const typeIcons = {
        'channel': 'üì¢',
        'supergroup': 'üë•',
        'group': 'üí¨'
    };

    return typeIcons[chat.type] || '‚ùì';
}

getChatAvatarStyle(chat) {
    const gradients = {
        'channel': 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
        'supergroup': 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
        'group': 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
    };

    return `background: ${gradients[chat.type] || 'var(--primary-gradient)'}`;
}

formatMemberCount(count) {
    if (!count || count <= 1) return 'Unknown';
    if (count < 1000) return count.toString();
    if (count < 1000000) return (count / 1000).toFixed(1) + 'K';
    return (count / 1000000).toFixed(1) + 'M';
}

formatChatType(type) {
    if (!type) return 'Unknown';
    const typeMap = {
        'group': 'Group',
        'supergroup': 'Supergroup', 
        'channel': 'Channel'
    };
    return typeMap[type.toLowerCase()] || type;
}

getEmptyStateHTML(type) {
    if (type === 'discovery') {
        if (!this.systemHealth.discovery) {
            return `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Discovery Service Unavailable</h3>
                    <p>The Discovery Service is not running. Please start it to discover groups automatically.</p>
                </div>
            `;
        }
        return `
            <div class="empty-state">
                <i class="fas fa-search"></i>
                <h3>No groups found</h3>
                <p>Try running a discovery scan or adjusting your filters</p>
            </div>
        `;
    } else {
        return `
            <div class="empty-state">
                <i class="fas fa-plus-circle"></i>
                <h3>No groups configured yet</h3>
                <p>Drag groups from the left panel or use the quick configure button</p>
            </div>
        `;
    }
}

updateUI() {
    this.renderDiscoveredChats();
    this.renderConfiguredGroups();
    this.updateStats();
}

updateStats() {
    document.getElementById('discoveredCount').textContent = this.discoveredChats.length;
    document.getElementById('configuredCount').textContent = this.configuredGroups.length;
    document.getElementById('activeCount').textContent = this.configuredGroups.filter(g => g.is_active).length;
}

// ============= ACTION METHODS =============

async quickConfigureChat(chatId) {
    const chat = this.discoveredChats.find(c => c.id === chatId);
    if (!chat) {
        this.showNotification('Chat not found', 'error');
        return;
    }

    if (!this.systemHealth.replicator) {
        this.showNotification('Message Replicator service is not available', 'error');
        return;
    }

    try {
        this.showNotification(`‚öôÔ∏è Configuring ${chat.title}...`, 'info');
        
        // Get webhook from environment variables
        const webhook_url = "https://discord.com/api/webhooks/1399873931695100005/FByKlMB9JI_eUR-WXaRiFiP8pYdZbS7dCrpyPO66gK09DBnCeAvYBRv4--knBZU5HCBM";
        
        const config = {
            group_id: chatId,
            group_name: chat.title,
            webhook_url: webhook_url,
            enabled: true,
            filters: {
                exclude_bots: true,
                include_media: true,
                min_length: 1
            },
            transformations: {
                add_prefix: `[${chat.title}] `,
                watermark: false
            }
        };
        
        const response = await fetch(this.API.replicator.addGroup, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            if (result.success) {
                // Add to configured groups immediately for instant feedback
                this.configuredGroups.push({
                    id: chatId,
                    title: chat.title,
                    type: "configured",
                    is_configured: true,
                    is_active: true,
                    webhook_url: webhook_url,
                    message_count: 0,
                    last_activity: new Date().toISOString()
                });
                
                this.updateUI();
                this.showNotification(`‚úÖ ${chat.title} configured successfully!`, 'success');
                this.animateItemMove(chatId);
            } else {
                throw new Error(result.message || 'Configuration failed');
            }
        } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `HTTP ${response.status}`);
        }
    } catch (error) {
        console.error('Quick configure error:', error);
        this.showNotification(`‚ùå Failed to configure ${chat.title}: ${error.message}`, 'error');
    }
}

async toggleGroup(groupId) {
    const group = this.configuredGroups.find(g => g.id === groupId);
    if (!group) return;

    try {
        const action = group.is_active ? 'disable' : 'enable';
        const response = await fetch(`http://localhost:8001/api/config/groups/${groupId}/${action}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                group.is_active = !group.is_active;
                this.updateUI();
                this.showNotification(`‚úÖ ${group.title} ${action}d successfully`, 'success');
            }
        } else {
            throw new Error(`Failed to ${action} group`);
        }
    } catch (error) {
        console.error('Toggle group error:', error);
        this.showNotification(`‚ùå Failed to toggle ${group.title}`, 'error');
    }
}

async removeGroup(groupId) {
    const group = this.configuredGroups.find(g => g.id === groupId);
    if (!group) return;

    if (!confirm(`Are you sure you want to remove "${group.title}" from configuration?`)) {
        return;
    }

    try {
        const response = await fetch(`http://localhost:8001/api/config/groups/${groupId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            this.configuredGroups = this.configuredGroups.filter(g => g.id !== groupId);
            this.updateUI();
            this.showNotification(`‚úÖ ${group.title} removed successfully`, 'success');
        } else {
            throw new Error('Remove failed');
        }
    } catch (error) {
        console.error('Remove group error:', error);
        this.showNotification(`‚ùå Failed to remove ${group.title}`, 'error');
    }
}

editGroup(groupId) {
    this.showNotification('Edit configuration feature coming soon!', 'info');
}

previewChat(chatId) {
    this.showNotification('Chat preview feature coming soon!', 'info');
}

animateItemMove(chatId) {
    const sourceItem = document.querySelector(`[data-chat-id="${chatId}"]`);
    if (sourceItem) {
        sourceItem.style.transform = 'translateX(100%) scale(0.8)';
        sourceItem.style.opacity = '0';
        
        setTimeout(() => {
            this.updateUI();
        }, 300);
    }
}

async startDiscoveryScan() {
    if (!this.systemHealth.discovery) {
        this.showNotification('Discovery Service is not available', 'error');
        return;
    }

    try {
        this.showNotification('üîÑ Starting discovery scan...', 'info');
        
        const response = await fetch(this.API.discovery.scan, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ force_refresh: true, max_chats: 500 })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                this.showNotification('‚úÖ Discovery scan started successfully', 'success');
                
                // Refresh data after a delay
                setTimeout(async () => {
                    await this.loadData();
                    this.updateUI();
                    this.showNotification('üéâ Discovery data refreshed', 'success');
                }, 5000);
            } else {
                throw new Error(result.message || 'Scan failed');
            }
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        console.error('Discovery scan error:', error);
        this.showNotification(`‚ùå Failed to start discovery scan: ${error.message}`, 'error');
    }
}

async refreshAllData() {
    this.showNotification('üîÑ Refreshing all data...', 'info');
    
    try {
        await this.checkSystemHealth();
        await this.loadData();
        this.updateUI();
        this.showNotification('‚úÖ Data refreshed successfully', 'success');
    } catch (error) {
        console.error('Refresh error:', error);
        this.showNotification('‚ùå Failed to refresh data', 'error');
    }
}

startRealTimeUpdates() {
    // Check system health periodically
    setInterval(() => {
        this.checkSystemHealth();
    }, 30000);

    // Refresh data periodically if services are healthy
    setInterval(async () => {
        if (this.systemHealth.discovery || this.systemHealth.replicator) {
            await this.loadData();
            this.updateUI();
        }
    }, 60000);
}

showNotification(message, type = 'info') {
    // Remove existing notifications
    document.querySelectorAll('.notification').forEach(n => n.remove());

    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    
    const iconMap = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-circle',
        'warning': 'fas fa-exclamation-triangle',
        'info': 'fas fa-info-circle'
    };

    notification.innerHTML = `
        <i class="${iconMap[type] || iconMap.info}"></i>
        <span>${message}</span>
        <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
    `;

    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (document.body.contains(notification)) {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }
    }, 5000);
}
}

// ============= GLOBAL FUNCTIONS =============

function startDiscoveryScan() {
           if (window.groupsHub) {
               window.groupsHub.startDiscoveryScan();
           }
       }

       function refreshAllData() {
           if (window.groupsHub) {
               window.groupsHub.refreshAllData();
           }
       }

       // ============= INITIALIZATION =============

       document.addEventListener('DOMContentLoaded', () => {
           try {
               console.log('üé≠ Starting Enterprise Groups Hub...');
               window.groupsHub = new EnterpriseGroupsHub();
           } catch (error) {
               console.error('‚ùå Failed to initialize Groups Hub:', error);

               // Show error page
               document.body.innerHTML = `
                   <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; color: white; text-align: center; padding: 2rem;">
                       <div style="background: var(--bg-card); padding: 3rem; border-radius: 20px; border: 1px solid var(--border-glass); backdrop-filter: blur(20px); max-width: 600px;">
                           <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #f59e0b; margin-bottom: 2rem;"></i>
                           <h1 style="margin-bottom: 1rem; font-size: 2rem;">Groups Hub Failed to Initialize</h1>
                           <p style="color: var(--text-secondary); margin-bottom: 2rem; line-height: 1.6; font-size: 1.1rem;">
                               The Groups Hub could not start properly. This usually happens when:<br><br>
                               ‚Ä¢ <strong>Discovery Service</strong> is not running on port 8002<br>
                               ‚Ä¢ <strong>Message Replicator</strong> is not running on port 8001<br>
                               ‚Ä¢ Network connectivity issues<br>
                               ‚Ä¢ Browser compatibility problems
                           </p>
                           <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 2rem;">
                               <button onclick="location.reload()" style="padding: 1rem 2rem; background: #3b82f6; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                                   <i class="fas fa-refresh"></i> Retry
                               </button>
                               <button onclick="window.open('/health', '_blank')" style="padding: 1rem 2rem; background: var(--bg-glass); color: white; border: 1px solid var(--border-glass); border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                                   <i class="fas fa-stethoscope"></i> Check System Health
                               </button>
                               <button onclick="window.open('/dashboard', '_blank')" style="padding: 1rem 2rem; background: var(--success-gradient); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 1rem;">
                                   <i class="fas fa-tachometer-alt"></i> Main Dashboard
                               </button>
                           </div>
                           <div style="background: rgba(0, 0, 0, 0.3); padding: 1.5rem; border-radius: 12px; font-family: monospace; text-align: left;">
                               <strong>Quick Diagnosis:</strong><br>
                               1. Check if all services are running<br>
                               2. Verify .env configuration<br>
                               3. Check browser console (F12) for errors<br>
                               4. Ensure port 8000, 8001, 8002 are available
                           </div>
                           <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 2rem;">
                               Need help? Check the system documentation or contact support.<br>
                               Error details are available in the browser console (F12).
                           </p>
                       </div>
                   </div>
               `;
           }
       });

       // Global error handler
       window.addEventListener('error', (event) => {
           console.error('Global error:', event.error);
           if (window.groupsHub) {
               window.groupsHub.showNotification('An unexpected error occurred. Please refresh the page.', 'error');
           }
       });

       // Enhanced network monitoring
       window.addEventListener('online', () => {
           if (window.groupsHub) {
               window.groupsHub.showNotification('üåê Connection restored', 'success');
               setTimeout(() => {
                   window.groupsHub.checkSystemHealth();
                   window.groupsHub.loadData();
               }, 1000);
           }
       });

       window.addEventListener('offline', () => {
           if (window.groupsHub) {
               window.groupsHub.showNotification('üì° Connection lost - working offline', 'warning');
           }
       });

       // Performance monitoring
       window.addEventListener('load', () => {
           const loadTime = performance.now();
           console.log(`üöÄ Groups Hub loaded in ${loadTime.toFixed(2)}ms`);
       });

       // Debug helpers for development
       if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
           window.groupsHubDebug = {
               reload: () => location.reload(),
               clearCache: () => {
                   localStorage.clear();
                   sessionStorage.clear();
                   location.reload();
               },
               testNotification: (type = 'info') => {
                   if (window.groupsHub) {
                       window.groupsHub.showNotification(`Test ${type} notification`, type);
                   }
               },
               showStats: () => {
                   if (window.groupsHub) {
                       console.table({
                           'Discovered Chats': window.groupsHub.discoveredChats.length,
                           'Configured Groups': window.groupsHub.configuredGroups.length,
                           'Active Groups': window.groupsHub.configuredGroups.filter(g => g.is_active).length,
                           'Discovery Service': window.groupsHub.systemHealth.discovery ? 'Online' : 'Offline',
                           'Replicator Service': window.groupsHub.systemHealth.replicator ? 'Online' : 'Offline',
                           'Current Filter': window.groupsHub.currentFilter || 'None',
                           'Search Term': window.groupsHub.searchTerm || 'None'
                       });
                   }
               },
               forceRefresh: () => {
                   if (window.groupsHub) {
                       window.groupsHub.loadData().then(() => {
                           window.groupsHub.updateUI();
                           console.log('‚úÖ Forced refresh completed');
                       });
                   }
               },
               testServices: async () => {
                   if (window.groupsHub) {
                       await window.groupsHub.checkSystemHealth();
                       console.log('System Health:', window.groupsHub.systemHealth);
                   }
               }
           };

           console.log('üõ†Ô∏è Debug helpers available:');
           console.log('  groupsHubDebug.reload() - Reload page');
           console.log('  groupsHubDebug.clearCache() - Clear cache and reload');
           console.log('  groupsHubDebug.testNotification(type) - Test notifications');
           console.log('  groupsHubDebug.showStats() - Show current stats');
           console.log('  groupsHubDebug.forceRefresh() - Force data refresh');
           console.log('  groupsHubDebug.testServices() - Test service connectivity');
       }

       // Memory cleanup on page unload
       window.addEventListener('beforeunload', () => {
           if (window.groupsHub) {
               // Clear any intervals or timeouts
               console.log('üßπ Cleaning up Groups Hub...');
           }
       });

       console.log('üé≠ Groups Hub Enterprise - Fully Loaded');
       console.log('üìã Features enabled:');
       console.log('  ‚úÖ Auto-discovery integration');
       console.log('  ‚úÖ Real-time configuration');
       console.log('  ‚úÖ Enhanced drag & drop');
       console.log('  ‚úÖ System health monitoring');
       console.log('  ‚úÖ Error boundary handling');
       console.log('  ‚úÖ Network status monitoring');
       console.log('  ‚úÖ Smart fallback systems');
   </script>
</body>
</html>
