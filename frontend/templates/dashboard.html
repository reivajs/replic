<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ¯ Universal Replication Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #667eea;
            --secondary: #48bb78;
            --danger: #f56565;
            --warning: #ed8936;
            --dark: #1a202c;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #667eea 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            background: var(--glass);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--secondary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .container {
            max-width: 1600px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-title {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .flows-section {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .flow-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--glass);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .flow-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .flow-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--secondary);
        }

        .flow-status.paused {
            background: var(--warning);
        }

        .flow-details {
            display: flex;
            flex-direction: column;
        }

        .flow-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .flow-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .flow-stats {
            text-align: right;
        }

        .error-message {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: none;
        }

        .loading {
            text-align: center;
            color: var(--text-secondary);
            padding: 2rem;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-infinity"></i>
                <span>Universal Replication Center</span>
            </div>
            <div class="status-badge">
                <span class="status-indicator" id="status-indicator"></span>
                <span id="system-status">Connecting...</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="error-message" class="error-message"></div>
        
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">
                    <i class="fas fa-envelope"></i> Messages Received
                </div>
                <div class="stat-value" id="messages-received">-</div>
                <div class="stat-meta">
                    Rate: <span id="message-rate">0</span>/min
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-title">
                    <i class="fas fa-share"></i> Messages Replicated
                </div>
                <div class="stat-value" id="messages-replicated">-</div>
                <div class="stat-meta">
                    Success: <span id="success-rate">0</span>%
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-title">
                    <i class="fas fa-project-diagram"></i> Active Flows
                </div>
                <div class="stat-value" id="active-flows">-</div>
                <div class="stat-meta">
                    <span id="total-accounts">0</span> accounts
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-title">
                    <i class="fas fa-clock"></i> Uptime
                </div>
                <div class="stat-value" id="uptime">-</div>
                <div class="stat-meta">
                    Latency: <span id="latency">0</span>ms
                </div>
            </div>
        </div>

        <!-- Active Flows -->
        <div class="flows-section">
            <h2 class="section-title">
                <i class="fas fa-stream"></i>
                Active Replication Flows
            </h2>
            <div id="flows-container">
                <div class="loading">Loading flows...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = '/api/v1/dashboard';
        const UPDATE_INTERVAL = 3000; // 3 seconds
        
        // State
        let updateTimer = null;
        let errorCount = 0;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Dashboard initialized');
            startUpdates();
        });
        
        // Start periodic updates
        function startUpdates() {
            updateDashboard();
            updateTimer = setInterval(updateDashboard, UPDATE_INTERVAL);
        }
        
        // Stop updates
        function stopUpdates() {
            if (updateTimer) {
                clearInterval(updateTimer);
                updateTimer = null;
            }
        }
        
        // Update dashboard data
        async function updateDashboard() {
            try {
                // Fetch all data
                const [statsRes, flowsRes, healthRes] = await Promise.all([
                    fetch(`${API_BASE}/api/stats`),
                    fetch(`${API_BASE}/api/flows`),
                    fetch(`${API_BASE}/api/health`)
                ]);
                
                // Parse responses
                const stats = await statsRes.json();
                const flowsData = await flowsRes.json();
                const health = await healthRes.json();
                
                // Reset error count on success
                errorCount = 0;
                hideError();
                
                // Update UI
                updateStats(stats);
                updateFlows(flowsData.flows || []);
                updateHealth(health);
                
            } catch (error) {
                console.error('Dashboard update error:', error);
                errorCount++;
                
                if (errorCount > 3) {
                    showError('Failed to connect to server. Retrying...');
                }
            }
        }
        
        // Update statistics
        function updateStats(stats) {
            // Update values
            updateElement('messages-received', stats.messages_received || 0);
            updateElement('messages-replicated', stats.messages_replicated || 0);
            updateElement('active-flows', stats.active_flows || 0);
            updateElement('total-accounts', stats.total_accounts || 0);
            updateElement('uptime', stats.uptime_formatted || '0h 0m');
            updateElement('success-rate', (stats.success_rate || 0).toFixed(1));
            updateElement('latency', stats.avg_latency || 0);
            
            // Calculate message rate
            const rate = Math.round((stats.messages_received || 0) / Math.max(1, (stats.uptime_seconds || 1) / 60));
            updateElement('message-rate', rate);
        }
        
        // Update flows display
        function updateFlows(flows) {
            const container = document.getElementById('flows-container');
            
            if (flows.length === 0) {
                container.innerHTML = '<div class="loading">No active flows</div>';
                return;
            }
            
            container.innerHTML = flows.map(flow => `
                <div class="flow-item">
                    <div class="flow-info">
                        <span class="flow-status ${flow.status === 'paused' ? 'paused' : ''}"></span>
                        <div class="flow-details">
                            <div class="flow-name">${flow.name}</div>
                            <div class="flow-meta">${flow.source} â†’ ${flow.destination}</div>
                        </div>
                    </div>
                    <div class="flow-stats">
                        <div><strong>${flow.messages_today}</strong></div>
                        <div class="flow-meta">messages today</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Update health status
        function updateHealth(health) {
            const statusEl = document.getElementById('system-status');
            const indicatorEl = document.getElementById('status-indicator');
            
            if (health.status === 'operational') {
                statusEl.textContent = 'System Operational';
                indicatorEl.style.background = 'var(--secondary)';
            } else if (health.status === 'degraded') {
                statusEl.textContent = 'System Degraded';
                indicatorEl.style.background = 'var(--warning)';
            } else {
                statusEl.textContent = 'System Down';
                indicatorEl.style.background = 'var(--danger)';
            }
        }
        
        // Helper: Update element text
        function updateElement(id, value) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value;
            }
        }
        
        // Show error message
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
        
        // Hide error message
        function hideError() {
            const errorEl = document.getElementById('error-message');
            errorEl.style.display = 'none';
        }
        
        // Handle visibility change (pause updates when hidden)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopUpdates();
            } else {
                startUpdates();
            }
        });
    </script>
</body>
</html>